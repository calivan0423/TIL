

# THE ZigBee NWK Layer

![image](https://user-images.githubusercontent.com/43804441/52836294-82d81780-312d-11e9-9131-db3d59f0f352.png)
  
  NWK 층은 데이터와 관리 , 2가지 서비스 타입을 제공한다.
  NWK층 DATA ENTITY , NLDE는 데이터 전송에 대한 책임을 가진다.
  데이터 서비스는 NLDE SAP를 통해 접근 된다.
  NWK 관리 의무들은 NLME에 의해 다루어진다.  다음 상위 계층인 APL 층에서는 NLME-SAP를 통해 NWK 관리 서비스를 이용할 수 있다.
  NWK층은 자체 상수와 속성들을 가진다. 모든 NWK층 상수는 nwkc의 접두사를 가진다.
  NWK층 속성들은 nwk라는 접두사를 가진다. nwk 속성들은 NWK-NIB에 에 저장된다.
  NWK 상수와 변수들의 리스트는 지그비 표준 문서를 ㅌㅇ해 제공된다.
  APL층은 NLME-GET과 NLME-SET 기본요소를 사용하여 NWK 속성들을 읽고 수정할 수 있다.
  
  지그비 코디네이터의 NWK층은 네트워크의 각 장비들에게 16비트 네트워크 주소를 할당한다.
  PAN 코디네이터를 포함한 지그비 코디네이터는 , 네트워크에 가입한 새 장비가 MAC 주소를 필요로 할 경우 IEEE 802.15.4 MAC 주소를 할당한다.
  네트워크 주소는 장비에 할당된 16 비트 IEEE 802.15.4 짧은 주소와 동일해야만 한다.
  
  NWK 층은 프레임이 네트워크를 이동할 수 있는 거리를 제한한다.
  그 거리는 홉으로 정의도니다.
  radius라고 불리는 매개변수는 홉의 최대 수를 결정하기 위하여 각 NWK 프레임에 추가된다.
  예를들어, radius의 초기 값이 3이라면, 메세지는 3번 이상 전달되지 않는다.
  radius의 값은 메세지가 전송될 때마다 감소하고, radius 값이 0이되면 프레임은 더 이상 전송되지 않는다.
  
  통신 매거니즘은 브로드캐스트,멀티캐스트,유니캐스트 3가지 일반적 카테고리로 나누어진다.
  
![image](https://user-images.githubusercontent.com/43804441/52837007-5a055180-3130-11e9-8d90-13a93513a076.png)


  특별한 경우가 없으면 유니캐스트가 디폴트 모드가 된다. 
  
  
  ## 브로드 캐스팅
  
    브로드캐스팅에서 메세지는,주소나 PAN 식별자와 관련없이, 특정 채널을 사용하는 모든 장비들에게 수신되는 것을 목적으로 하고 있다.
    장비가 패킷을 수신할 때마다 장비는 자신이 패킷 수신의 목적지인지 확인하기 위하여 패킷에 제공된 목적지 주소를 체크할 것이다.
    IEEE 802.15.4의 브로트캐스트에서, 짧은 주소 모드가 사용되고 목적지 주소는 0xFFFF로 설정된다.
    이 주소는 패킷을 자신의 주소로 수신하는 모든 장비에 의해 수신될 것이다.
    PAN 식별자는 OxFFFF로 설정될 수 있다. 수신장비는 OxFFFF를 유효한 PAN 식별자로 받아드릴 것이다. 
    OxFFFF의 MAC 주소는 브로드캐스트 주소로 알려져있다.
    OxFFFF의 PAN 식별자는 브로드캐스트 PAN 식별자로 불려진다.
    
    IEEE 802.15.4가 멀티 네트워크를 통해 메세지를 브로드캐스트하기 위해서 브로트캐스트 PAN 식별자를 사용하는 것을 지원함에도
    지그비 표준은 멀티 네트워크를 통한 브로드캐스트를 허용하지 않고 PAN 식별자는 항상 지그비 네트워크의 PAN 식별자로 설정된다.
    네트워크 내 장비의 APS 부계층은 NWK층 데이터 서비스를 사용하여 브로드캐스트 전송을 시작할 수 있다.
    
    대규모 네트워크에서, 브로드 캐스트 메세지를 수신한 모든 장비가 발송자에게 수신확인을 보내는 것은 어렵고 불필요할 것이다.
    그러므로 메세지가 브로드캐스트 되면 종단 장비는 메세지 수신의 성공에 대한 ACK가 허용되지 않는다.
    대신에 지그비 코디네이터와 지그비 라우터는 이웃한 장비가 성공적으로 전달된 메세지를 가지고 있는지 확인한다.
    이는 passive acknowledgment 매커니즘이라 불린다.
    패시브 승인에서, 장비가 메세지를 브로드캐스트한 후, 장비는 수신 모드가 될 것이고 이웃 장비로 부터 같은 프레임이 재브로드캐스트 되기를 기다린다.
    재브로드캐스트 메세지는 이웃장비가 성공적으로 메세지를 수신했고 전달했음을 나타낸다.
    
    지그비 코디네이터와 라우터는 브로드캐스트 전송 테이블 BTT에 그들이 브로드 캐스트한 모든 메세지의 기록을 유지한다.
    이 기록은 브로드캐스트 전송 기록 BTR이라고 하고 브로드 캐스트 프레임의 순서번호와 소스 주소를 포함한다.
    모든 지그비 라우터는 최소한 NWK층의 1개 프레임만큼의 버퍼 크기가 요구된다.
    버퍼링 기능은 브로드캐스트들의 재전송에 도움이 된다.
    각 BTR은 제한된 시간 주기 동안에만 유효하고 생성 후 nwkNetworkBroadcastDeliveryTime 시간이 지나면 폐기된다.
    폐기된 BTR은 BTT가 가득차고 새 BTR이 생성되면 덮어 쓰여진다.
    
    만약 지그비 종단 장비가 유후 상태 동안 수신 모드를 켜놓을 수 없으면, 그 장비는 브로드캐스트 전달에 참여하지 않거나 BTT를 유지하지 않는다.
    만약 macRxOnWhenIdle가 FALSE로 설정된 지그비 라우터가 브로드캐스트 메세지를 수신하면, 브로드 캐스트 매커니즘을 사용하지 않을 것이다.
    대신에 유니캐스트를 사용하여 지연없이 이웃한 장비들에게 개별적으로 메세지를 전달할 것이다.
    여기서, 주소 필드는 브로드캐스트 주소가 아닌 목적지 장비의 주소를 포함할 것이다.
    
    브로드캐스트 동안, 메세지는 여러 장비에 전달되고 숨겨진 노드 문제로 인한 충돌 가능성이 있다.
    이 가능성을 줄이기 위하여, NWK층은 각 전송 전에 장비가 랜덤한 주기를 기다릴 것을 요청한다.
    이 랜덤 대기 기간을 브로드캐스트 지터 라고 한다.
    브로드캐스트 지터의 길이는 nwkcMaxBroadcastJitter의 속성 값(밀리초)보다 작아야한다.
    
    
    
    
    
    
    
    
    
    
    
  
  
