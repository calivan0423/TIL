

# THE ZigBee NWK Layer

![image](https://user-images.githubusercontent.com/43804441/52836294-82d81780-312d-11e9-9131-db3d59f0f352.png)
  
  NWK 층은 데이터와 관리 , 2가지 서비스 타입을 제공한다.
  NWK층 DATA ENTITY , NLDE는 데이터 전송에 대한 책임을 가진다.
  데이터 서비스는 NLDE SAP를 통해 접근 된다.
  NWK 관리 의무들은 NLME에 의해 다루어진다.  다음 상위 계층인 APL 층에서는 NLME-SAP를 통해 NWK 관리 서비스를 이용할 수 있다.
  NWK층은 자체 상수와 속성들을 가진다. 모든 NWK층 상수는 nwkc의 접두사를 가진다.
  NWK층 속성들은 nwk라는 접두사를 가진다. nwk 속성들은 NWK-NIB에 에 저장된다.
  NWK 상수와 변수들의 리스트는 지그비 표준 문서를 ㅌㅇ해 제공된다.
  APL층은 NLME-GET과 NLME-SET 기본요소를 사용하여 NWK 속성들을 읽고 수정할 수 있다.
  
  지그비 코디네이터의 NWK층은 네트워크의 각 장비들에게 16비트 네트워크 주소를 할당한다.
  PAN 코디네이터를 포함한 지그비 코디네이터는 , 네트워크에 가입한 새 장비가 MAC 주소를 필요로 할 경우 IEEE 802.15.4 MAC 주소를 할당한다.
  네트워크 주소는 장비에 할당된 16 비트 IEEE 802.15.4 짧은 주소와 동일해야만 한다.
  
  NWK 층은 프레임이 네트워크를 이동할 수 있는 거리를 제한한다.
  그 거리는 홉으로 정의도니다.
  radius라고 불리는 매개변수는 홉의 최대 수를 결정하기 위하여 각 NWK 프레임에 추가된다.
  예를들어, radius의 초기 값이 3이라면, 메세지는 3번 이상 전달되지 않는다.
  radius의 값은 메세지가 전송될 때마다 감소하고, radius 값이 0이되면 프레임은 더 이상 전송되지 않는다.
  
  통신 매거니즘은 브로드캐스트,멀티캐스트,유니캐스트 3가지 일반적 카테고리로 나누어진다.
  
![image](https://user-images.githubusercontent.com/43804441/52837007-5a055180-3130-11e9-8d90-13a93513a076.png)


  특별한 경우가 없으면 유니캐스트가 디폴트 모드가 된다. 
  
  
## Broadcasting 
  
   브로드캐스팅에서 메세지는,주소나 PAN 식별자와 관련없이, 특정 채널을 사용하는 모든 장비들에게 수신되는 것을 목적으로 하고 있다.
   장비가 패킷을 수신할 때마다 장비는 자신이 패킷 수신의 목적지인지 확인하기 위하여 패킷에 제공된 목적지 주소를 체크할 것이다.
   IEEE 802.15.4의 브로트캐스트에서, 짧은 주소 모드가 사용되고 목적지 주소는 0xFFFF로 설정된다.
   이 주소는 패킷을 자신의 주소로 수신하는 모든 장비에 의해 수신될 것이다.
   PAN 식별자는 OxFFFF로 설정될 수 있다. 수신장비는 OxFFFF를 유효한 PAN 식별자로 받아드릴 것이다. 
   OxFFFF의 MAC 주소는 브로드캐스트 주소로 알려져있다.
   OxFFFF의 PAN 식별자는 브로드캐스트 PAN 식별자로 불려진다.
    
   IEEE 802.15.4가 멀티 네트워크를 통해 메세지를 브로드캐스트하기 위해서 브로트캐스트 PAN 식별자를 사용하는 것을 지원함에도
   지그비 표준은 멀티 네트워크를 통한 브로드캐스트를 허용하지 않고 PAN 식별자는 항상 지그비 네트워크의 PAN 식별자로 설정된다.
   네트워크 내 장비의 APS 부계층은 NWK층 데이터 서비스를 사용하여 브로드캐스트 전송을 시작할 수 있다.
    
   대규모 네트워크에서, 브로드 캐스트 메세지를 수신한 모든 장비가 발송자에게 수신확인을 보내는 것은 어렵고 불필요할 것이다.
   그러므로 메세지가 브로드캐스트 되면 종단 장비는 메세지 수신의 성공에 대한 ACK가 허용되지 않는다.
   대신에 지그비 코디네이터와 지그비 라우터는 이웃한 장비가 성공적으로 전달된 메세지를 가지고 있는지 확인한다.
   이는 passive acknowledgment 매커니즘이라 불린다.
   패시브 승인에서, 장비가 메세지를 브로드캐스트한 후, 장비는 수신 모드가 될 것이고 이웃 장비로 부터 같은 프레임이 재브로드캐스트 되기를 기다린다.
   재브로드캐스트 메세지는 이웃장비가 성공적으로 메세지를 수신했고 전달했음을 나타낸다.
    
   지그비 코디네이터와 라우터는 브로드캐스트 전송 테이블 BTT에 그들이 브로드 캐스트한 모든 메세지의 기록을 유지한다.
   이 기록은 브로드캐스트 전송 기록 BTR이라고 하고 브로드 캐스트 프레임의 순서번호와 소스 주소를 포함한다.
   모든 지그비 라우터는 최소한 NWK층의 1개 프레임만큼의 버퍼 크기가 요구된다.
   버퍼링 기능은 브로드캐스트들의 재전송에 도움이 된다.
   각 BTR은 제한된 시간 주기 동안에만 유효하고 생성 후 nwkNetworkBroadcastDeliveryTime 시간이 지나면 폐기된다.
   폐기된 BTR은 BTT가 가득차고 새 BTR이 생성되면 덮어 쓰여진다.
    
   만약 지그비 종단 장비가 유후 상태 동안 수신 모드를 켜놓을 수 없으면, 그 장비는 브로드캐스트 전달에 참여하지 않거나 BTT를 유지하지 않는다.
   만약 macRxOnWhenIdle가 FALSE로 설정된 지그비 라우터가 브로드캐스트 메세지를 수신하면, 브로드 캐스트 매커니즘을 사용하지 않을 것이다.
   대신에 유니캐스트를 사용하여 지연없이 이웃한 장비들에게 개별적으로 메세지를 전달할 것이다.
   여기서, 주소 필드는 브로드캐스트 주소가 아닌 목적지 장비의 주소를 포함할 것이다.
    
   브로드캐스트 동안, 메세지는 여러 장비에 전달되고 숨겨진 노드 문제로 인한 충돌 가능성이 있다.
   이 가능성을 줄이기 위하여, NWK층은 각 전송 전에 장비가 랜덤한 주기를 기다릴 것을 요청한다.
   이 랜덤 대기 기간을 브로드캐스트 지터 라고 한다.
   브로드캐스트 지터의 길이는 nwkcMaxBroadcastJitter의 속성 값(밀리초)보다 작아야한다.
   
![image](https://user-images.githubusercontent.com/43804441/52838285-7952ad80-3135-11e9-8419-41661b02add9.png)

   위 그림의 순서 차트는 브로드캐스트 전송을 나타낸다.
   BTT는 각 장비가 이웃 장비로 부터 브로드캐스트 전송을 받고 난 후에 업데이트 된다.
   장비 A가 브로드캐스트를 시작하고 장비 B로부터 브로드캐스트 BACK 프레임을 수신한다.
   장비 A가 두 번째로 브로드 캐스트 메세지를 수신하면 , 장비 A는 이미 그 프레임을 수신했기 때문에 무시한다.
   장비 B는 프레임을 브로드캐스트하고 패시브 승인 동안 기다린다.
   만약 장비B가 nwkPassiveAckTimeout만큼 기다리고 어떤 패시브 승인도 수신하지 않는다면, 장비 B는 프레임을 재전송할 것이다.
   위 그림의 예에서 장비 B는 패시브 승인을 받기 때문에 재전송을 하지 않는다.
   
 
## Multicasting
    
   멀티캐스트에서 메세지는 전체 네트워크 대신에 같은 네트워크의 장비 그룹에게 전달된다.
   예를 들어 밝기 조절 어플리케이션에서 스위치 역할을 하는 장치에 의해 전송되는 단일 프레임은 집 안의 조명 그룹을 켜거나 끌 수 있다.
   비록 이는 각 단일 전구에 연속적인 유니캐스트 전송을 하는 것과 동일한 결과를 보이지만, 단일 멀티캐스느는 장비의 그룹에게
   같은 메세지를 전달함에 좀 더 효율적인 방법이다.
    
   각 그룹은 16비트 멀티캐스트 그룹id로 구별된다.
   같은 그룹의 장비들은 그룹 번호로 알려진다. 장비는 1개 이상의 멀티캐스트 그룹의 멤버가 될 수 있다.
   각 장비는 multicast table ( nwkGroupIDTable) 라고 불리는 테이블에 멀티캐스트 그룹 멤버십의 목록을 유지한다.
    
   장비는 멀티캐스트를 사용하여 멤버에 도달할수 있기 때문에 멀티캐스트 그룹의 멤버일 필요가 없다....????????
   멀티캐스트 수행에는 멤버모드와 논멤버모드 2가지가 있다.
   멤버모드에서, 멀티캐스트는 멤버 장비에 의해 시작하고 멀티캐스트 그룹의 멤버에게 보내진다.
   논멤버 모드에서, 멀티캐스트그룹의 멤버가 아닌 장비는 멀티캐스트 그룹의 멤버에게 메세지를 라우팅하며,
   여기서 메세지는 그룹의 멤버에게 보내질 것이다.
    
![image](https://user-images.githubusercontent.com/43804441/52838915-9ee0b680-3137-11e9-89c5-7b43edb3afa4.png)

   그림 3.32는 멤버 모드와 논멤버모드 멀티캐스팅을 설명한다.
   NWK 데이터 프레임은 자신이 멤버 혹은 논멤버 장비로 부터 수신된 것인지를 명확히 하기 위하여 멀티캐스트 모드 필드를 가진다.
   이 예에서, 멀티캐스트는 논멤버 장비로부터 시작한다.
   APL 계층으로부터 수신된 페이로드에 포함된 멀티캐스트 그룹 ID가 그것의 멀티캐스트 테이블에 저장된
   어떤 장치 멀티캐스트 그룹 ID와 일치하지 않는다면 "그것은 의도된 멀티캐스트 그룹의 멤버가 아니라는 것을 " 알고 있다.
   그림 3.32에서 소스 장비는 NWK 프레임을 구성하고 프레임의 멀티캐스트 모드 필드를 논멤버 모드로 설정한다.
   
   이 전송 이전에 경로 발견이 수행되었다고 가정하면, 소스 장비는 다음 홉의 주소를 안다.
   그것은 연속 유니캐스트를 통해 이 프레임을 멤버 디바이스로 유도하는 경로가 이미 설정되었음을 의미한다.
   소스 장비는 목적지 주소 필드를 다음 홉의 주소와 동일하게 설정한다.
   프레임을 수신하는 다음 장비는 또한 논멤버 장비이고 유니캐스팅을 사용해 다음 장비로 메세지를 전달한다.
   이 과정은 프레임이 멀티캐스트 그룹의 멤버인 장비에게 수신될 때까지 지속한다.
   
   회원 장치는 수신된 프레임의 멀티캐스트 모드 필드를 변경하여 메시지가 회원 장치로부터 전송되고 있음을 나타낼 것이다.
   이 시점으로부터, 회원 장치에 의해 개시된 것처럼 메시지를 송신한다. 
   멀티캐스트 멤버 장비는 메세지를 유니캐스트 하지 않는다.
   대신에 메세지는 프레임의 목저지 주소를 브로드캐스트 주소Oxffff와 동일하게 설정함으로서 브로드캐스트 된다.
   멤버 모드 멀티캐스트들은 그 프레임들이 브로드 캐스트인 거처럼 BTT에 기록을 해둔다.
   멀티캐스트에서는 , 브로드캐스트와 대조적으로, 패시브 승인이 없다.
   
   브로드캐스팅에 참가하는 장비들은 nwkcMaxBroadcastJitter 속성보다 적은 랜덤한 시간 주기를 기다리고 나서 프레임을 브로드캐스트 할 것이다.
   이 브로드캐스트 프레임은 멤버와 논멤버 모두에게 도착할 수 있다.
   양쪽 모두 자신의 BTT가 가득 차지 않고 이전에 같은 프레임을 브로드캐스트 하지 않았다면 수신된 프레임을 재 브로드캐스트할 것이다.
   
   멀티캐스팅에서, 논멤버 장비에 의한 멀티캐스트 프레임이 재브로드캐스트 되는 수를 제한할 수 있다.
   브로드 캐스트 프레임은 nonmembet raduis라는 필드를 가지는데 이는 프레임이 논멤버 장비에 의해 재브로드캐스트 될때마다 감소한다.
   이 필드가 0이 되면, 프레임은 논멤버에 의해 더 이상 재브로드 되어지지 않는다.
   
   위 필드가 007로 설정되는 유일한 예외일때, 제한이 없다는 것을 의미한다.
   또한 멤버 장비가 멀티캐스트 프레임을 재브로드 할때마다, 위 필드는 허용된 최대 값으로 설정된다.
   또한 이 최대 값은 멀티캐스트 되고 있는 프레임에도 포함된다.
   
   지그비 표준에서, 멀티캐스트는 데이터 전송을 위해서만 사용되고, 어떤 명령 프레임도 멀티캐스트 되는 것이 허용되지 않는다.
   
### Many to One communication


![image](https://user-images.githubusercontent.com/43804441/52839835-ba00f580-313a-11e9-9f19-6adfae0dfb03.png)

   그림 3.33은 같은 네트워크에서 단일 장비가 여러 장비로 부터 메세지를 수신하는 통신 시나리오를 보여준다.
   이는 many to one 통신이라고 불린다.
   메세지를 수신한 장비는 sink라고 불린다.
   ZigBee 무선 네트워킹에서 싱크는 주어진 반경 내에 있는 모든 ZigBee 라우터와 ZigBee 코디네이터로부터 스스로 경로를 설정한다. 
   
    

### Hierachical (Tree) Topology

![image](https://user-images.githubusercontent.com/43804441/52840435-9b036300-313c-11e9-965a-58b0a58d41fb.png)
  
   위 그림의 트리 네트워크는 트리의 루트로 활동하는 지그비 코디네이터로부터 시작한다.
   지그비 코디네이터 또는 라우터는 부모 장비로 활동할 수 있고 네트워크의 다른 장비로 부터 연결을 받아들일 수 있다.
   부모 장비와 연결된 장비는 자식 장비라고 한다.
   자식을 위한 메세지는 부모를 통해 라우트 된다.
   지그비 종단 장비는 라우팅 기능이 부족하기 때문에 자식으로서만 활동할 수 있다.
   트리 토폴로지는 hierarchical 토폴로지라고 한다.
   
   네트워크 깊이는 부모/자녀 링크만 사용하는 경우 프레임에 ZigBee 코디네이터에 도달하는 데 필요한 최소 홉 수로 정의된다.
   지그비 코디네이터의 직계 아동은 단지 한 홉으로 지그비 코디네이터에게 프레임을 보낼 수 있기 때문에 1의 깊이를 가진다.
   지그비 코디네이터는 0의 깊이를 가진다.
   
   지그비 표준은 트리 네트워크의 장비에게 주소를 할당하기 위하여 매커니즘을 제공한다.
   이를 default distributed address allocation라고 한다.
   그러나 어플리케이션 개발자들은 그들의 주소 할당 방법을 사용하도록 허락해야한다.
   지그비 코디네이터가 네트워크를 구성하려고 시작할 때, nwkUseTreeAddrAlloc 속성이 TRUE로 설정되었다면 
   코디네이터는 디폴트 분산 주소지정 계획을 사용할 것이다.
   이 분산된 주소지정에서 지그비 코디네이터는 네트워크 주소의 서브블록을 각 잠재적인 부모에게 제공한다.
   부모는 이 주소들을 자식에게 할당할 것이다. 지그비 코디네이터는 각 부모에게 할당된 자식의 최대 수를 결정한다.
   nwkUseTreeAddrAlloc가 false로 설정되면, apl 층은 nwk에게 사용자 정의 주소지정을 제공할 것이다.
   
   디폴트 주소 할당은 주소를 할당하기 위하여 깊이와 자식의 최대 수를 사용한다.
   주소 할당에 영향을 주는 매개변수들은 아래와 같다
   
      Lm : 네트워크 최대 깊이 (nwkMaxDepth)
      
      Cm : 부모가 받아들일 수 있는 최대 자식 수 (nwkMaxChildren)
      
      Rm : 부모가 받아들일 수 있는 최대 라우팅 수용 자식 수 (nwkMaxRouters)
      
      d : 네트워크에서 장비의 깊이
  

![image](https://user-images.githubusercontent.com/43804441/52841707-524da900-3140-11e9-8ecc-4c65c7afb798.png)
  
  
   그림 3.35은 주소 할당의 예를 보여준다. Lm=3, Cm=Rm=2.이다
   주소 할당은 0주소를 지그비 코디네이터에 할당하는 것으로 시작한다.
   나머지 장비의 주소를 결정하려고 간단한 기능(Cskip(d))이 소개된다. 
   

![image](https://user-images.githubusercontent.com/43804441/52841865-bf613e80-3140-11e9-985f-fe5f2efc04bd.png) 

   그림 3.35의 예에서, 각 깊이의 Cskip(d)의 값은 계산되어진다.
   각 깊이에서, 어떤 두 개의 라우팅 가능 장치들의 주소 사이의 차이는 그들의 부모들의 Cskip 값의 정수 배이다.
   예를 들어, 그림 3.35에서 장비 x 주소는 지그비 코디네이터의 주소의 단일 증가이다.
   장비 y의 주소는 장비 x의 주소에 그들의 부모의 Cskip 값을 더해서 정해진다.
   그러므로 y의 주소는 8과 같다. 나머지 라우팅이 가능한 장비들의 주소는 간단히 정해진다.(위처럼)
   
   만약 Cskip의 계산된 값이 0이 되면,그 장비는 더 이상 자식을 가질 수 없다는 것을 의미한다.
   
   그림 3.35에서, 3깊이의 장비들은 Cskip값이 0이다.
   라우팅이 불가능한 종단 장비의 주소는 다르게 계산된다.
   각 종단 장비의 주소는 다음에 따라 결정된다.
   

![image](https://user-images.githubusercontent.com/43804441/52842257-e1a78c00-3141-11e9-8b88-19ef21566ace.png)

   Cskip (d )은 기기가 다른 장치를 대신하여 목적지를 향해 메시지를 전달할 것으로 예상되는 경우에 도움이 될 수 있다.
   릴레이 장치는 대상 장치가 릴레이 장치의 후예인지 여부를 알아야 한다.
   만약 릴레잉 장비가 깊이 d에 있고 그 주소가 A와 같다면, D의 목적지 주소의 목적지 장비는  다음 관계가 TRUE일 때 릴레잉 장비의 후예이다.
   
![image](https://user-images.githubusercontent.com/43804441/52842479-917cf980-3142-11e9-8cbb-b5723b06c43e.png)

   목적지가 장비의 후예임을 깨달은 후에, 다음 단계는 다음 홉의 주소를 계산하는 것이다.
   만약 목적지가 자식 장비 중 하나라면, 다음 홉의 주소는 목적지의 주소와 같을 것이다.
   만약 목적지가 자식이 아니고 후예인 경우 다음 홉의 주소는 아래 계산과 같을 것이다.
   
![image](https://user-images.githubusercontent.com/43804441/52842633-0d774180-3143-11e9-9c0d-05ea11c4bc63.png)

   소스 장비는 프레임 전송을 시작하는 장비이다.
   hierarchical(계층적) 토폴로지에서, 장비는 프로엠이 유효한 경로를 따라 수신된 경우에만 프레임을 전달한다.
   다음의 조건들 중 하나를 만족하면 경로가 유효하다.
  
   * 자식 장비들 중 하나로 부터 프레임이 도착하거나 소스 장비가 그 자식의 후예이다.....???
      
   * 부모 장비로부터 프레임이 수신되거나 소스 장비가 그 장비의 후예가 아닌 경우...??
   
   스타 폴로지는 네트워크에서 유일한 부모가 지그비 코디네이터인 트리 네트워크의 특별한 형태로 간주될 수 있다.
   스타 네트워크에서, 모든 자식들은 깊이가 1이고 지그비 코디네이터와 직접 통신한다.
   자식이 아닌 것들은 스타 네트워크에서 라우터로서 활동한다.
   스타 토폴로지에서 장비는 지그비 코디네이터가 아닌 다른 장비와 직접 통신할 수 없다.
   이 절에서 논의된 주소 할당 방법은 ZigBee-2006과 ZigBee-2007 모두에 적용된다. ZigBee-Pro는 확률적 주소 할당도 지원한다.
   
   
### MESH Topology      
   
    
   트리 토폴로지와 대조적으로 mesh 토폴로지에서는 계층적인 관계가 없다.
   메시 토폴로지의 장비들은 메세지 발신자를 대신하여 메세지를 전달하기 위해 라우팅이 가능한 장비를 이용하여 혹은 직접 다른 장비에
   접촉을 하려고 시도할 수 있다.
   메시 토폴로지에서 목적지를 향한 소스 장비로부터의 경로는 필요에 따라 생성되고 환경이 변화하면 수정할 수 있다.
   경로를 생성하고 수정하기위한 메시 토폴로지의 기능은 무선 연결의 신뢰를 급격히 증가시킨다.
   어떤 이유에서든, 소스 장비가 이전에 설립된 경로를 사용하여 목적지 장비와 통신할 수 없다면, 네트워크의 라우팅 가능 장비는 
   소스 장비에서 목적지 장비로의 다른 대안 경로를 찾기 위하여 협동할 것이다.
   이것은 경로 발견 및 정비 에 관한 아래 내용에서 더 정확히 다룰 것이다.
   
    
    
    
    
  
  
