

# THE ZigBee NWK Layer

![image](https://user-images.githubusercontent.com/43804441/52836294-82d81780-312d-11e9-9131-db3d59f0f352.png)
  
  NWK 층은 데이터와 관리 , 2가지 서비스 타입을 제공한다.
  NWK층 DATA ENTITY , NLDE는 데이터 전송에 대한 책임을 가진다.
  데이터 서비스는 NLDE SAP를 통해 접근 된다.
  NWK 관리 의무들은 NLME에 의해 다루어진다.  다음 상위 계층인 APL 층에서는 NLME-SAP를 통해 NWK 관리 서비스를 이용할 수 있다.
  NWK층은 자체 상수와 속성들을 가진다. 모든 NWK층 상수는 nwkc의 접두사를 가진다.
  NWK층 속성들은 nwk라는 접두사를 가진다. nwk 속성들은 NWK-NIB에 에 저장된다.
  NWK 상수와 변수들의 리스트는 지그비 표준 문서를 ㅌㅇ해 제공된다.
  APL층은 NLME-GET과 NLME-SET 기본요소를 사용하여 NWK 속성들을 읽고 수정할 수 있다.
  
  지그비 코디네이터의 NWK층은 네트워크의 각 장비들에게 16비트 네트워크 주소를 할당한다.
  PAN 코디네이터를 포함한 지그비 코디네이터는 , 네트워크에 가입한 새 장비가 MAC 주소를 필요로 할 경우 IEEE 802.15.4 MAC 주소를 할당한다.
  네트워크 주소는 장비에 할당된 16 비트 IEEE 802.15.4 짧은 주소와 동일해야만 한다.
  
  NWK 층은 프레임이 네트워크를 이동할 수 있는 거리를 제한한다.
  그 거리는 홉으로 정의도니다.
  radius라고 불리는 매개변수는 홉의 최대 수를 결정하기 위하여 각 NWK 프레임에 추가된다.
  예를들어, radius의 초기 값이 3이라면, 메세지는 3번 이상 전달되지 않는다.
  radius의 값은 메세지가 전송될 때마다 감소하고, radius 값이 0이되면 프레임은 더 이상 전송되지 않는다.
  
  통신 매거니즘은 브로드캐스트,멀티캐스트,유니캐스트 3가지 일반적 카테고리로 나누어진다.
  
![image](https://user-images.githubusercontent.com/43804441/52837007-5a055180-3130-11e9-8d90-13a93513a076.png)


  특별한 경우가 없으면 유니캐스트가 디폴트 모드가 된다. 
  
  
## Broadcasting 
  
   브로드캐스팅에서 메세지는,주소나 PAN 식별자와 관련없이, 특정 채널을 사용하는 모든 장비들에게 수신되는 것을 목적으로 하고 있다.
   장비가 패킷을 수신할 때마다 장비는 자신이 패킷 수신의 목적지인지 확인하기 위하여 패킷에 제공된 목적지 주소를 체크할 것이다.
   IEEE 802.15.4의 브로트캐스트에서, 짧은 주소 모드가 사용되고 목적지 주소는 0xFFFF로 설정된다.
   이 주소는 패킷을 자신의 주소로 수신하는 모든 장비에 의해 수신될 것이다.
   PAN 식별자는 OxFFFF로 설정될 수 있다. 수신장비는 OxFFFF를 유효한 PAN 식별자로 받아드릴 것이다. 
   OxFFFF의 MAC 주소는 브로드캐스트 주소로 알려져있다.
   OxFFFF의 PAN 식별자는 브로드캐스트 PAN 식별자로 불려진다.
    
   IEEE 802.15.4가 멀티 네트워크를 통해 메세지를 브로드캐스트하기 위해서 브로트캐스트 PAN 식별자를 사용하는 것을 지원함에도
   지그비 표준은 멀티 네트워크를 통한 브로드캐스트를 허용하지 않고 PAN 식별자는 항상 지그비 네트워크의 PAN 식별자로 설정된다.
   네트워크 내 장비의 APS 부계층은 NWK층 데이터 서비스를 사용하여 브로드캐스트 전송을 시작할 수 있다.
    
   대규모 네트워크에서, 브로드 캐스트 메세지를 수신한 모든 장비가 발송자에게 수신확인을 보내는 것은 어렵고 불필요할 것이다.
   그러므로 메세지가 브로드캐스트 되면 종단 장비는 메세지 수신의 성공에 대한 ACK가 허용되지 않는다.
   대신에 지그비 코디네이터와 지그비 라우터는 이웃한 장비가 성공적으로 전달된 메세지를 가지고 있는지 확인한다.
   이는 passive acknowledgment 매커니즘이라 불린다.
   패시브 승인에서, 장비가 메세지를 브로드캐스트한 후, 장비는 수신 모드가 될 것이고 이웃 장비로 부터 같은 프레임이 재브로드캐스트 되기를 기다린다.
   재브로드캐스트 메세지는 이웃장비가 성공적으로 메세지를 수신했고 전달했음을 나타낸다.
    
   지그비 코디네이터와 라우터는 브로드캐스트 전송 테이블 BTT에 그들이 브로드 캐스트한 모든 메세지의 기록을 유지한다.
   이 기록은 브로드캐스트 전송 기록 BTR이라고 하고 브로드 캐스트 프레임의 순서번호와 소스 주소를 포함한다.
   모든 지그비 라우터는 최소한 NWK층의 1개 프레임만큼의 버퍼 크기가 요구된다.
   버퍼링 기능은 브로드캐스트들의 재전송에 도움이 된다.
   각 BTR은 제한된 시간 주기 동안에만 유효하고 생성 후 nwkNetworkBroadcastDeliveryTime 시간이 지나면 폐기된다.
   폐기된 BTR은 BTT가 가득차고 새 BTR이 생성되면 덮어 쓰여진다.
    
   만약 지그비 종단 장비가 유후 상태 동안 수신 모드를 켜놓을 수 없으면, 그 장비는 브로드캐스트 전달에 참여하지 않거나 BTT를 유지하지 않는다.
   만약 macRxOnWhenIdle가 FALSE로 설정된 지그비 라우터가 브로드캐스트 메세지를 수신하면, 브로드 캐스트 매커니즘을 사용하지 않을 것이다.
   대신에 유니캐스트를 사용하여 지연없이 이웃한 장비들에게 개별적으로 메세지를 전달할 것이다.
   여기서, 주소 필드는 브로드캐스트 주소가 아닌 목적지 장비의 주소를 포함할 것이다.
    
   브로드캐스트 동안, 메세지는 여러 장비에 전달되고 숨겨진 노드 문제로 인한 충돌 가능성이 있다.
   이 가능성을 줄이기 위하여, NWK층은 각 전송 전에 장비가 랜덤한 주기를 기다릴 것을 요청한다.
   이 랜덤 대기 기간을 브로드캐스트 지터 라고 한다.
   브로드캐스트 지터의 길이는 nwkcMaxBroadcastJitter의 속성 값(밀리초)보다 작아야한다.
   
![image](https://user-images.githubusercontent.com/43804441/52838285-7952ad80-3135-11e9-8419-41661b02add9.png)

   위 그림의 순서 차트는 브로드캐스트 전송을 나타낸다.
   BTT는 각 장비가 이웃 장비로 부터 브로드캐스트 전송을 받고 난 후에 업데이트 된다.
   장비 A가 브로드캐스트를 시작하고 장비 B로부터 브로드캐스트 BACK 프레임을 수신한다.
   장비 A가 두 번째로 브로드 캐스트 메세지를 수신하면 , 장비 A는 이미 그 프레임을 수신했기 때문에 무시한다.
   장비 B는 프레임을 브로드캐스트하고 패시브 승인 동안 기다린다.
   만약 장비B가 nwkPassiveAckTimeout만큼 기다리고 어떤 패시브 승인도 수신하지 않는다면, 장비 B는 프레임을 재전송할 것이다.
   위 그림의 예에서 장비 B는 패시브 승인을 받기 때문에 재전송을 하지 않는다.
   
 
## Multicasting
    
   멀티캐스트에서 메세지는 전체 네트워크 대신에 같은 네트워크의 장비 그룹에게 전달된다.
   예를 들어 밝기 조절 어플리케이션에서 스위치 역할을 하는 장치에 의해 전송되는 단일 프레임은 집 안의 조명 그룹을 켜거나 끌 수 있다.
   비록 이는 각 단일 전구에 연속적인 유니캐스트 전송을 하는 것과 동일한 결과를 보이지만, 단일 멀티캐스느는 장비의 그룹에게
   같은 메세지를 전달함에 좀 더 효율적인 방법이다.
    
   각 그룹은 16비트 멀티캐스트 그룹id로 구별된다.
   같은 그룹의 장비들은 그룹 번호로 알려진다. 장비는 1개 이상의 멀티캐스트 그룹의 멤버가 될 수 있다.
   각 장비는 multicast table ( nwkGroupIDTable) 라고 불리는 테이블에 멀티캐스트 그룹 멤버십의 목록을 유지한다.
    
   장비는 멀티캐스트를 사용하여 멤버에 도달할수 있기 때문에 멀티캐스트 그룹의 멤버일 필요가 없다....????????
   멀티캐스트 수행에는 멤버모드와 논멤버모드 2가지가 있다.
   멤버모드에서, 멀티캐스트는 멤버 장비에 의해 시작하고 멀티캐스트 그룹의 멤버에게 보내진다.
   논멤버 모드에서, 멀티캐스트그룹의 멤버가 아닌 장비는 멀티캐스트 그룹의 멤버에게 메세지를 라우팅하며,
   여기서 메세지는 그룹의 멤버에게 보내질 것이다.
    
![image](https://user-images.githubusercontent.com/43804441/52838915-9ee0b680-3137-11e9-89c5-7b43edb3afa4.png)

   그림 3.32는 멤버 모드와 논멤버모드 멀티캐스팅을 설명한다.
   NWK 데이터 프레임은 자신이 멤버 혹은 논멤버 장비로 부터 수신된 것인지를 명확히 하기 위하여 멀티캐스트 모드 필드를 가진다.
   이 예에서, 멀티캐스트는 논멤버 장비로부터 시작한다.
   APL 계층으로부터 수신된 페이로드에 포함된 멀티캐스트 그룹 ID가 그것의 멀티캐스트 테이블에 저장된
   어떤 장치 멀티캐스트 그룹 ID와 일치하지 않는다면 "그것은 의도된 멀티캐스트 그룹의 멤버가 아니라는 것을 " 알고 있다.
   그림 3.32에서 소스 장비는 NWK 프레임을 구성하고 프레임의 멀티캐스트 모드 필드를 논멤버 모드로 설정한다.
   
   이 전송 이전에 경로 발견이 수행되었다고 가정하면, 소스 장비는 다음 홉의 주소를 안다.
   그것은 연속 유니캐스트를 통해 이 프레임을 멤버 디바이스로 유도하는 경로가 이미 설정되었음을 의미한다.
   소스 장비는 목적지 주소 필드를 다음 홉의 주소와 동일하게 설정한다.
   프레임을 수신하는 다음 장비는 또한 논멤버 장비이고 유니캐스팅을 사용해 다음 장비로 메세지를 전달한다.
   이 과정은 프레임이 멀티캐스트 그룹의 멤버인 장비에게 수신될 때까지 지속한다.
   
   회원 장치는 수신된 프레임의 멀티캐스트 모드 필드를 변경하여 메시지가 회원 장치로부터 전송되고 있음을 나타낼 것이다.
   이 시점으로부터, 회원 장치에 의해 개시된 것처럼 메시지를 송신한다. 
   멀티캐스트 멤버 장비는 메세지를 유니캐스트 하지 않는다.
   대신에 메세지는 프레임의 목저지 주소를 브로드캐스트 주소Oxffff와 동일하게 설정함으로서 브로드캐스트 된다.
   멤버 모드 멀티캐스트들은 그 프레임들이 브로드 캐스트인 거처럼 BTT에 기록을 해둔다.
   멀티캐스트에서는 , 브로드캐스트와 대조적으로, 패시브 승인이 없다.
   
   브로드캐스팅에 참가하는 장비들은 nwkcMaxBroadcastJitter 속성보다 적은 랜덤한 시간 주기를 기다리고 나서 프레임을 브로드캐스트 할 것이다.
   이 브로드캐스트 프레임은 멤버와 논멤버 모두에게 도착할 수 있다.
   양쪽 모두 자신의 BTT가 가득 차지 않고 이전에 같은 프레임을 브로드캐스트 하지 않았다면 수신된 프레임을 재 브로드캐스트할 것이다.
   
   멀티캐스팅에서, 논멤버 장비에 의한 멀티캐스트 프레임이 재브로드캐스트 되는 수를 제한할 수 있다.
   브로드 캐스트 프레임은 nonmembet raduis라는 필드를 가지는데 이는 프레임이 논멤버 장비에 의해 재브로드캐스트 될때마다 감소한다.
   이 필드가 0이 되면, 프레임은 논멤버에 의해 더 이상 재브로드 되어지지 않는다.
   
   위 필드가 007로 설정되는 유일한 예외일때, 제한이 없다는 것을 의미한다.
   또한 멤버 장비가 멀티캐스트 프레임을 재브로드 할때마다, 위 필드는 허용된 최대 값으로 설정된다.
   또한 이 최대 값은 멀티캐스트 되고 있는 프레임에도 포함된다.
   
   지그비 표준에서, 멀티캐스트는 데이터 전송을 위해서만 사용되고, 어떤 명령 프레임도 멀티캐스트 되는 것이 허용되지 않는다.
   
## Many to One communication


![image](https://user-images.githubusercontent.com/43804441/52839835-ba00f580-313a-11e9-9f19-6adfae0dfb03.png)

   그림 3.33은 같은 네트워크에서 단일 장비가 여러 장비로 부터 메세지를 수신하는 통신 시나리오를 보여준다.
   이는 many to one 통신이라고 불린다.
   메세지를 수신한 장비는 sink라고 불린다.
   ZigBee 무선 네트워킹에서 싱크는 주어진 반경 내에 있는 모든 ZigBee 라우터와 ZigBee 코디네이터로부터 스스로 경로를 설정한다. 
   
    

## Hierachical (Tree) Topology

![image](https://user-images.githubusercontent.com/43804441/52840435-9b036300-313c-11e9-965a-58b0a58d41fb.png)
  
   위 그림의 트리 네트워크는 트리의 루트로 활동하는 지그비 코디네이터로부터 시작한다.
   지그비 코디네이터 또는 라우터는 부모 장비로 활동할 수 있고 네트워크의 다른 장비로 부터 연결을 받아들일 수 있다.
   부모 장비와 연결된 장비는 자식 장비라고 한다.
   자식을 위한 메세지는 부모를 통해 라우트 된다.
   지그비 종단 장비는 라우팅 기능이 부족하기 때문에 자식으로서만 활동할 수 있다.
   트리 토폴로지는 hierarchical 토폴로지라고 한다.
   
   네트워크 깊이는 부모/자녀 링크만 사용하는 경우 프레임에 ZigBee 코디네이터에 도달하는 데 필요한 최소 홉 수로 정의된다.
   지그비 코디네이터의 직계 아동은 단지 한 홉으로 지그비 코디네이터에게 프레임을 보낼 수 있기 때문에 1의 깊이를 가진다.
   지그비 코디네이터는 0의 깊이를 가진다.
   
   지그비 표준은 트리 네트워크의 장비에게 주소를 할당하기 위하여 매커니즘을 제공한다.
   이를 default distributed address allocation라고 한다.
   그러나 어플리케이션 개발자들은 그들의 주소 할당 방법을 사용하도록 허락해야한다.
   지그비 코디네이터가 네트워크를 구성하려고 시작할 때, nwkUseTreeAddrAlloc 속성이 TRUE로 설정되었다면 
   코디네이터는 디폴트 분산 주소지정 계획을 사용할 것이다.
   이 분산된 주소지정에서 지그비 코디네이터는 네트워크 주소의 서브블록을 각 잠재적인 부모에게 제공한다.
   부모는 이 주소들을 자식에게 할당할 것이다. 지그비 코디네이터는 각 부모에게 할당된 자식의 최대 수를 결정한다.
   nwkUseTreeAddrAlloc가 false로 설정되면, apl 층은 nwk에게 사용자 정의 주소지정을 제공할 것이다.
   
   디폴트 주소 할당은 주소를 할당하기 위하여 깊이와 자식의 최대 수를 사용한다.
   주소 할당에 영향을 주는 매개변수들은 아래와 같다
   
      Lm : 네트워크 최대 깊이 (nwkMaxDepth)
      
      Cm : 부모가 받아들일 수 있는 최대 자식 수 (nwkMaxChildren)
      
      Rm : 부모가 받아들일 수 있는 최대 라우팅 수용 자식 수 (nwkMaxRouters)
      
      d : 네트워크에서 장비의 깊이
  

![image](https://user-images.githubusercontent.com/43804441/52841707-524da900-3140-11e9-8ecc-4c65c7afb798.png)
  
  
   그림 3.35은 주소 할당의 예를 보여준다. Lm=3, Cm=Rm=2.이다
   주소 할당은 0주소를 지그비 코디네이터에 할당하는 것으로 시작한다.
   나머지 장비의 주소를 결정하려고 간단한 기능(Cskip(d))이 소개된다. 
   

![image](https://user-images.githubusercontent.com/43804441/52841865-bf613e80-3140-11e9-985f-fe5f2efc04bd.png) 

   그림 3.35의 예에서, 각 깊이의 Cskip(d)의 값은 계산되어진다.
   각 깊이에서, 어떤 두 개의 라우팅 가능 장치들의 주소 사이의 차이는 그들의 부모들의 Cskip 값의 정수 배이다.
   예를 들어, 그림 3.35에서 장비 x 주소는 지그비 코디네이터의 주소의 단일 증가이다.
   장비 y의 주소는 장비 x의 주소에 그들의 부모의 Cskip 값을 더해서 정해진다.
   그러므로 y의 주소는 8과 같다. 나머지 라우팅이 가능한 장비들의 주소는 간단히 정해진다.(위처럼)
   
   만약 Cskip의 계산된 값이 0이 되면,그 장비는 더 이상 자식을 가질 수 없다는 것을 의미한다.
   
   그림 3.35에서, 3깊이의 장비들은 Cskip값이 0이다.
   라우팅이 불가능한 종단 장비의 주소는 다르게 계산된다.
   각 종단 장비의 주소는 다음에 따라 결정된다.
   

![image](https://user-images.githubusercontent.com/43804441/52842257-e1a78c00-3141-11e9-8b88-19ef21566ace.png)

   Cskip (d )은 기기가 다른 장치를 대신하여 목적지를 향해 메시지를 전달할 것으로 예상되는 경우에 도움이 될 수 있다.
   릴레이 장치는 대상 장치가 릴레이 장치의 후예인지 여부를 알아야 한다.
   만약 릴레잉 장비가 깊이 d에 있고 그 주소가 A와 같다면, D의 목적지 주소의 목적지 장비는  다음 관계가 TRUE일 때 릴레잉 장비의 후예이다.
   
![image](https://user-images.githubusercontent.com/43804441/52842479-917cf980-3142-11e9-8cbb-b5723b06c43e.png)

   목적지가 장비의 후예임을 깨달은 후에, 다음 단계는 다음 홉의 주소를 계산하는 것이다.
   만약 목적지가 자식 장비 중 하나라면, 다음 홉의 주소는 목적지의 주소와 같을 것이다.
   만약 목적지가 자식이 아니고 후예인 경우 다음 홉의 주소는 아래 계산과 같을 것이다.
   
![image](https://user-images.githubusercontent.com/43804441/52842633-0d774180-3143-11e9-9c0d-05ea11c4bc63.png)

   소스 장비는 프레임 전송을 시작하는 장비이다.
   hierarchical(계층적) 토폴로지에서, 장비는 프로엠이 유효한 경로를 따라 수신된 경우에만 프레임을 전달한다.
   다음의 조건들 중 하나를 만족하면 경로가 유효하다.
  
   * 자식 장비들 중 하나로 부터 프레임이 도착하거나 소스 장비가 그 자식의 후예이다.....???
      
   * 부모 장비로부터 프레임이 수신되거나 소스 장비가 그 장비의 후예가 아닌 경우...??
   
   스타 폴로지는 네트워크에서 유일한 부모가 지그비 코디네이터인 트리 네트워크의 특별한 형태로 간주될 수 있다.
   스타 네트워크에서, 모든 자식들은 깊이가 1이고 지그비 코디네이터와 직접 통신한다.
   자식이 아닌 것들은 스타 네트워크에서 라우터로서 활동한다.
   스타 토폴로지에서 장비는 지그비 코디네이터가 아닌 다른 장비와 직접 통신할 수 없다.
   이 절에서 논의된 주소 할당 방법은 ZigBee-2006과 ZigBee-2007 모두에 적용된다. ZigBee-Pro는 확률적 주소 할당도 지원한다.
   
   
## MESH Topology      
   
    
   트리 토폴로지와 대조적으로 mesh 토폴로지에서는 계층적인 관계가 없다.
   메시 토폴로지의 장비들은 메세지 발신자를 대신하여 메세지를 전달하기 위해 라우팅이 가능한 장비를 이용하여 혹은 직접 다른 장비에
   접촉을 하려고 시도할 수 있다.
   메시 토폴로지에서 목적지를 향한 소스 장비로부터의 경로는 필요에 따라 생성되고 환경이 변화하면 수정할 수 있다.
   경로를 생성하고 수정하기위한 메시 토폴로지의 기능은 무선 연결의 신뢰를 급격히 증가시킨다.
   어떤 이유에서든, 소스 장비가 이전에 설립된 경로를 사용하여 목적지 장비와 통신할 수 없다면, 네트워크의 라우팅 가능 장비는 
   소스 장비에서 목적지 장비로의 다른 대안 경로를 찾기 위하여 협동할 것이다.
   이것은 경로 발견 및 정비 에 관한 아래 내용에서 더 정확히 다룰 것이다.
   
    
## Routing

   라우팅은 메세지가 목적지 장비로 전달 될 경로를 정하는 과정이다.
   지그비 코디네이터와 라우터는 네트워크에서 경로들을 발견하고 유지할 책임이 있다.
   지그비 종단 장비는 경로 찾기를 수행할 수 없고, 지그비 코디네이터 또는 라우터는 종단 장비의 동작에서 경로를 찾을 것이다.
   
   경로의 길이는 경로 중 장비의 수로 정의된다.
   
![image](https://user-images.githubusercontent.com/43804441/52915382-bd50d880-3316-11e9-98d1-b5562b93600e.png)

   그림 3.36은 길이 5와 7의 경로의 예를 보여준다.
   경로에서 두 연속적인 장비의 연결은 링크라고 불린다.
   위 그림에서 링키는 L1에서 L4이다.
   
   링크 품질, 홉의 수 그리고 에너지 절약 고려사항 같은 매개변수들은 각 라우팅 시나리오에서 최적의 경로를 결정하는데 사용된다.
   이 프로세스에서, 각 링크는 링크 비용으로 이루어진다.
   각 링크에서 성공적으로 패킷을 전달할 가능성은 링크 비용으로 결정된다.
   패킷 전달 성공 가능성이 낮을 수록 링크 비용이 높다.
   각 링크의 비용은 그림 3.36에서 C { [D i ,D i +1 ] }  처럼 나와 있다.
   
   링크 비용을 결정하는 다양한 방법이 있다. 지그비 표준은 다음과 같은 공식을 사용한다.
   
![image](https://user-images.githubusercontent.com/43804441/52915497-1e2ce080-3318-11e9-8831-a4c006846cfd.png)

  C{l}은 링크 L의 비용이다.
  링크 L의 패킷 전달 성공 가능성은 P(l)이다.
  라운드 함수는 숫를 가장 가까운 정수로 반올림 한다.
  비용은 항상 0부터 7까지의 정수이다. 
  
![image](https://user-images.githubusercontent.com/43804441/52915530-9bf0ec00-3318-11e9-8543-af8c5254911c.png)

  P(l)의 성공적인 패킷 전달 가능성은 다양한 방법으로 평가될 수 있고, ZigBee 표준은 구현자가 자신의 용도에 가장 적합한 방법을 선택할 수 있도록 한다
  그러나 패킷 전달 성공 가능성의 초기 평가는 LQI 평균에 기반한다.
  LQI는 각 수신된 패킷을 위해 기록되고, 신호 에너지 혹은 SNR을 가리킨다.
  일반적으로 패킷의 성공적인 가능성은 LQI가 증가할수록 증가한다.
  링크 비용을 계산하는 간단한 방법은 LQI의 다른 수준을 0에서 7까지의 링크 비용 수준에 직접 매핑하기 위해 조회표를 사용하는 것이다.
  이 표는 보통 7 실험의 결과 평균에 기초해 만들어진다.
  
  다른 경로를 비교하기 위해, 각 경로는 경로 비용과 관련이 있다.
  경로 비용 C{p}는 경로를 형성하는 링크의 비용의 요약이다.
  

![image](https://user-images.githubusercontent.com/43804441/52915624-cabb9200-3319-11e9-9665-cf6ad6f06da9.png)

  적은 경로 비용의 경로는 패킷 전달 성공 가능성이 가장 좋다.
  
  지그비 코디네이터와 라우터들은 라우팅 테이블을 만들고 유지한다. 테이블 3.9와 같이.
  

![image](https://user-images.githubusercontent.com/43804441/52915643-00607b00-331a-11e9-9d80-0f39009dd643.png)

  
  라우팅 테이블은 메세지를 특정한 목적지로 라우팅할 때 다음 홉을 결정하는데 사용된다.
  상태 필드는 경로의 상태를 결정한다. 
  라우팅 테이블 용량이라는 용어는 장치가 라우팅 테이블을 사용하여 특정 목적지 주소로 경로를 설정할 수 있음을 의미한다.
  
  라우팅과 관련된 다른 테이블은 라우팅 발견 테이블이고 이 것은 새 경로를 찾을 때 사용된다.(표 3.10)
  
![image](https://user-images.githubusercontent.com/43804441/52915688-6fd66a80-331a-11e9-954f-8d4097f9d3fe.png)
  
  경로 발견 테이블은 경로 비용, 경로(소스 장비)가 요청하는 장비의 주소, 그리고 현재 장비에서 연결된 마지막 장비의 주소를 포함한다.
  후자는 경로 발견 결과를 경로 요청 발신자(소스 장치)로 다시 전송하는 데 사용된다.
  
  라우팅 테이블과 대조적으로, 경로 발견 테이블의 내용은 임시적이고 nwkcRouteDiscoveryTime 밀리 초 후에 폐기된다.
  
  지그비 네트워크의 장비는 또한 이웃 테이블을 유지하는데 이는 전송 범위의 장비들에 대한 정보를 포함한다.(표 3.11과 같이)
  
![image](https://user-images.githubusercontent.com/43804441/52915750-0a36ae00-331b-11e9-87d3-4695c1c38932.png)

  이 표는 장비가 이웃 장비로 부터 패킷을 수신될 때마다 업데이트가 된다.
  이웃 테이블은 장비가 가까운 라우터를 찾거나 네트워크에 재가입 할 때 유용하다.
  장비는 또한 새 부모를 찾을 때 이웃 테이블을 사용한다.
  테이블 3.11은 모든 요청된 필드와 몇 가지 선택적 필드를 포함한다.
  선택적 필드의 목록은 지그비 사양에서 제공된다.
  
  트리 네트워크를 위한 라우팅 매커니즘은 계층적 라우팅이라고 불린다.
  만약 nwkUseTreeRouting 속성이 true로 설정되면, 장비는 계층적 라우팅을 사용할 수 있다.

  
  
  
## Route Discovery

  응용층은 NLME-ROUTE-DISCOVERY.request 프리미티브를 이용하여 유니캐스트,멀티캐스트 그리고 many-to-one 통신을 위한 nwk층이
  경로를 찾을 것을 요청한다.
  만약 경로 탐색 요청이 목적지로서의 각각의 장비 주소를 포함한다면, nwk층은 유니캐스트 경로 탐색을 수행할 것이다.
  유니캐스트 경로는 항상 단일 소스 주소로부터 시작하고 단일 목적지 주소로 끝난다.
  멀티캐스트 경로 탐색은 목적지 주소가 멀티캐스트 그룹의 16비트 그룹 id라면 시작할 것이다.
  마지막으로 만약 응용 층이 어떤 목적지 주소도 제공하지 않는다면, nwk은은 응용층이 다대일 경로 탐색을 요청했다고 가정할 것이다.
  다대일 경로는 경로 탐색이 요청된 장비들을 sink장비로서 배치할 것이다.
  
  오직 지그비 코디네이터와 라우터들만 경로 탐색 요청을 전달할 수 있다.
  또 지그비 표준은 브로드캐스팅을 위한 경로탐색을 허용하지 않는다.
  그러므로 만약 응용층이 nwk층에 브로드캐스트 주소(0xffff)와 같은 목적지 주소로 NLME-ROUTE-DISCOERY.request 프리미티브를 주는 경우,
  그 프리미티브는 무효 요청으로 처리될 것이다.
  
![image](https://user-images.githubusercontent.com/43804441/53283451-ef848f00-3789-11e9-9144-f298ec9ab1c4.png)

  그림 3.37은 유니캐스트 경로 탐색 예를 보여준다.
  이 시나리오에서 장비 A는 장비 F로의 경로를 찾는다.
  장비 A는 라우트 요청 명령을 브로드캐스팅함으로 경로 탐색을 시작한다.
  경로 요청 명령 프레임은 경로 요청 식별자와 목적지 주소 그리고 경로 비용 필드를 포함한다.
  경로 요청 식별자는 경로 요청을 위한 8비트 순서 번호이며 NWK층이 경로 요청을 발급할 때마다 1씩 증가한다.
  장비 A는 경로 요청 명령을 브로드캐스팅 하기 전에 경로 비용 필드를 0으로 설정할 것이다.
  
  브로드캐스트 명령은 A의 주파수 범위에 있고 같은 주파수를 청취하는 모든 장비에 의해 수신될 것이다.
  그림 3.37 에서, 장비 B와 장비 C는 경로 요청 명령을 수신한다. 장비 A는 패시브 확인응답을 기다릴 것이고 만약 브로드 캐스트가 실패하면,
  장비 A는 브로드캐스트 시작 이후에 nwkcInitialRREQRetries 값 만큼 재시도 할 것이다.
  이러한 재시도들은 nwkcRREQRetryInterval 밀리초 단위로 구분된다.
  
  만약 경로 요청 명령을 받은 장비가 지그비 종단 장비라면, 더 이상의 라우팅이 가능하지 않으므로 경로 요청 명령을 무시할 것이다.
  그림 3.37에서 장비A와 장비F 사이의 장비는 지그비 코디네이터이거나 지그비 라우터이다.
  장비B는 지그비 라우터이고 만약 장비B가 라우팅 용량을 가진다면, 경로 요청 명령의 경로 비용 필드를 a부터 b로의 경로 비용으로 추가할 것이고
  경로 요청 명령을 브로드캐스트 할 것이다.
  만약 장비 b 경로 탐색 테이블이 경로 요청 식별자와 소스 주소(a의 주소)를 포함하지 않는다면, 장비b는 경로 탐색 테이블을 관련하여 업데이트할 것이다.
    
  만약 장비b 라우팅 테이블이 가득하고 목적지 주소가 라우팅 테이블에 없다면, 네트워크가 계층적 라우팅에 기초할 것이라고 가정하면서
  경로 요청 명릉은 유효한 경로에 의해 수신되고 장비 b는 경로 요청 명령을 트리를 통하여 유니캐스트 할 것이다.....????????????
  그러나 만약 장비b의 라우팅 테이블이 가득하고 경로 요청이 유효한 경로로 수신되지 않는다면, 장비b는 경로 요청 명령을 무시할 것이다.
  
  장비 c 또한 지그비 라우터이고 경로 요청 명령을 받을 때 장비 b와 같이 행동할 것이다.
  그림 3.37에서 장비 b와 c로 부터의 브로드캐스트들은 장비 d와 e에 도착할 것이다.
  장비 d와 e는 그들이 라우팅 용량이 있다고 가정하면서 경로 요청을 다시 재 브로드 할 것이다.
  다른 어떤 브로드캐스트와도 비슷하게 각 장비는 랜덤한 딜레이(브로드캐스트 지터)와 함께 브로드캐스트를 시작할 것이다.
  경로 탐색에서 이 지연은 2 * nwkcMinRREQJitter and 2 * nwkcMaxRREQJitter 사이의 랜덤한 값이다.
  
  예를 들어 장비 d는 같은 경로 요청 명령을 다른 전달 장비로 부터 수신한다고 가정한다.
  장비 d는 경로 탐색 테이블이 송신장비에서 d로의 가장 적은 경로 비용을 포함하게끔 업데이트할 것이다.
  이것은 장치 A를 향한 경로 발견의 결과를 통신할 때 장치 D에 도움이 될 것이다.
  이때 장치 D는 장치 A에 대한 가장 낮은 경로 비용을 기준으로 경로 탐색 표에서 다음 홉을 선택하기만 하면 된다.
  
  연속적인 브로드 캐스팅은 경로 요청 명령이 의도된 목적지에 도달할 때까지 반복된다.
  장비 f는 a에서 f로의 최소 경로를 선택하기 위해서 각 수신된 경로 요청명령의 모든 축적 경로 비용을 사용할 것이다.
  장비 f는 장비a에게 경로 응답 명령을 전송하기 위한 다음 홉으로서 장비 d또는 장비 e를 선택할 것이다.
  예를 들어 장비d가 다음 홉이라면 장비 d는 장비a에게 경로 응답 명령을 전달하기 위한 다음 홉을 찾기 위해서 자신의 경로 탐색 테이블을 사용할 것이다.
  
  장비a에서 장비 f로의 경로는 포워드 경로라고 불린다.
  장비f에서 장비 a로의 경로는 백워드 경로라고 한다.
  라우팅은 대칭이거나 비대칭이 될수 있다.
  대칭 라우팅이 선택될 때, nwkSymLink를 true로 설정함으로서 포워드와 백워드 경로가 동일하게 된다.
  즉, 그림 3.37에서 메세지는 대칭 라우팅을 사용한다.
  만약 nwkSymLink이 false이면 장비 f는 다른 경로 탐색을 필요로 한다.
  
  유니캐스트 경로 탐색과 비슷하게, 멀티캐스트 경로 탐색은 소스 장비에 의한 경로 요청 명령의 브로드 캐스트로 시작한다.
  소스 장치는 경로 검색이 진행 중이라는 사실을 반영하기 위해 라우팅 테이블을 만들거나 기존 테이블을 업데이트한다.
  
  이 브로드캐스트를 수신하고 라우팅 용량을 가진 어떤 장치라도 해당 장치가 요청된 멀티캐스트 그룹의 멤버인지 여부를 알기 위해 
  브로드캐스트 프레임이 제공하는 멀티캐스트 그룹 ID와 그것의 멀티캐스트 테이블의 그룹 ID를 비교할 것이다.
  만약 수신 장비가 요청된 멀티캐스트 그룹의 멤버가 아니라면, 이 멀티캐스트 경로 탐색은 유니캐스트 경로 탐색처럼 다루어질 것이지만
  목적지 주소는 멀티캐스트 그룹 id로 설정된다.
  
  만약 수신 장비가 요청된 멀티캐스트 그룹의 멤버라면,  이 새 경로 탐색 요청을 위한 경로 탐색 테이블을 만들거나 업데이트할 것이다.
  만약 이 멤버 장비가 경로 탐색 테이블에 이미 존재하는 소스 장비 주소, 같은 경로 요청 식별자와 일치하는 경우 가장 낮은 경로 비용을 가진
  것으로 경로 탐색 테이블을 유지할 것이다.
  멤버 장비는 유니캐스트 경로 탐색과 비슷하게 경로 의존 명령을 소스장비로 보낼 것이다.
  

### source Routing

  지그비 nwk 층은 소스 라우팅의 사용을 허용한다. 소스 라우팅매커니즘에서,
  프레임 제공자는 전달 역할을 할 모든 장치의 목록을 만들고 그것들을 NWK 프레임 자체에 포함한다.
  이 방법으로, 라우팅 장치가 이 프레임을 수신할 때, 프레임에 포함된 전송 목록에서 다음 노드의 주소를 간단히 찾는다.
  이 릴레이 목록에는 인덱스가 항상 다음 홉의 주소를 가리키도록 프레임이 릴레이될 때마다 증가되는 인덱스가 있다.
  즉, 소스 라우팅에서는 프레임을 중계하는 장치가 자체 라우팅 테이블 대신 릴레이 목록에서 다음 홉 주소를 조회한다.
  
  
![image](https://user-images.githubusercontent.com/43804441/53283625-9ec26580-378c-11e9-8007-89d702c1f893.png)

  
## Route maintenance and repair

 경로가 탐색되고 메세지 전달하는 동안을 위해 사용된 후에, 목적지에 메세지를 전달할 수 없는 사고가 발생할 수 있다.
 그 이유는 네트워크 자체 문제(라우터가 꺼져있거나 제거된 경우) 또는 환경(어떤 물체가 두 장비간 무선 통신을 방해하는 경우)가 있다.
 경로의 생성이나 보수에 필요한 노력을 고려할 때, 경로의 메시지 전달에 실패하는 즉시 경로 보수 절차에 착수하는 것은 권장되지 않는다.
 그 대신 링크 고장으로 인해 나가는 프레임이 고장난 횟수만큼 카운터를 유지하는 것이 좋다.
 경로 수리 절차는 이 카운터가 nwkcRepairThreshold를 초과 할 때 시작할 것이다.
 이는 또한 링크가 실패한 수를 기록하는 것이 가능하다.
 이것은 일시적인 연결 고장과 영구적인 연결 고장의 구별에 도움이 될 것이다. 
 응용 프로그램 개발자는 사용 사례 시나리오에 근거하여 경로 수리를 시작하기 위한 최선의 방법을 결정할 것이다.
 
 만약 경로 에러가 다대일 토폴로지에서 발생하면, 링크 실패 장비는 경로 에러 명령 프레임을 랜덤한 이웃에게 보낼 것이다.
 모든 이웃들은 싱크(대상) 장치로 가는 라우팅 테이블을 가질 것으로 예상된다.
 이웃 장비들은 싱크 장비로 경로 에러 명령 프레임을 보낼 것이다.
 
 그림 3.38은 메쉬 네트워크에서 경로 수리의 예를 보여준다. 장비 a와 b 사이의 링크가 실패되고 경로 수리가 요청된다.
 경로 보수 절차는 원래 소스 장치 대신 장치 A가 경로 검색을 시작한다는 점을 제외하면 경로 검색과 유사하다.
 장비 a는 목적지로의 새 경로를 찾기 위해 경로 요청 명령 프레임을 브로드 캐스팅 할 때,
 소스 주소로서 자신의 주소를 사용할 것이다.
 경로 보수와 경로 탐색은 모두 경로 ㅛ청 명령을 사용한다.
 경로 보수를 경로 탐색과 구별하기 위해서, 경로 요청 명령 프레임의 경로 보수 비트 서브 필드는 1로 설정된다.
 
 그림 3.38에서 연속적인 경로 요청 브로드캐스트 이후에 새 경로는 소스와 목적지 주소 사이에 설립된다.
 이 방법을 통해, 새 경로는 원래 경로의 몇 장비들에게 공유 된다.
 만약 장비a가 어떤 이유로 목적지로의 새 경로를 설립할 수 없으면, 경로 에러 명령 프레임을 소스 장비로 유니캐스트해서 보낸다.
 이 경우 소스 장비는 목적지로의 경로를 설립하기 위해서 경로 보수 대신에 새 결로 탐색을 시작한다.
 
 
## THE nwk layer data service
  
 nwk층은 APS 부계층 프로토콜 유닛 (APDU)의 형태에서 APS 부계층으로 부터 전송될 필요가 있는 데이터를 수신한다.
 APDU와 NWK층헤더의 결합은 NWK층 프로토콜 데이터 유닛 NPDU를 형성한다.
 
 APS 부계층은 NLDE-DATA.requset 프리미티브를 사용하여 네트워크의 다른 장비의 aps 부계층으로 데이터 전송을 요청한다.
 데이터 전송 요청은 데이터가 radius 매개변수를 사용하여 네트워크에서 이동가능한 거리를 제한한다.
 데이터는 순서번호와 동반된다. 순서 번호는 랜덤 번호로 시작하고 데이터 프레임이 한번 전송 될 때마다 증가한다.
 수신자 측에서, nwk층은 NLDE-DATA.indication 프리미티브를 사용하여 APS 부계층에 데이트 프레임,LQI,그리고 데이터 순서 번호를 전송한다.
  
  
## THE NWK Layer management service
 
 nwk층 메인 책임들은 네트워크 형성, 가입그리고 탈퇴, 경로 탐색 그리고 경로 유지이다.
 nwk층 라우팅과 경로 탐색은 위에서 설명했다.
 아래에서는 nwk층의 나머지 관리 책임에 대해 설명할 것이다.


### Network Discovery

  

 네트워크 발견 절차는 장비 POS에서 현재 작동 중인 모든 네트워크를 발견하기 위해서 사용된다.
 장비 발견 요청은 응용층에 의해 NWK층으로 제공된다.
 NWK층은 다른 네트워크의 존재를 발견하기 위해서 MAC 계층 채널 스캐닝을 사용한다.
 활동 (액티브) 스캔은 만약 장비가 액티브 스캔을 수행할 수 있다면, 선호되는 스캔 방식이다.
 그렇지 않으면 장비는 패시브 스캔을 수행할 것이다.

 네트워크 발견 수행은 각 네트워크가 사용하는 PAN 식별자, 현재 주파수 채널 
 그리고 지그비 프로토콜 버전을 포함한 발견된 네트워크 목록을 응용층으로 전 달한다.
 이 정보는 또한 비콘 오더의 값, 네트워크의 슈퍼프레임 오터 그리고 지그비 스택 프로파일 식별자를 포함 한다.
 네트워크 발견은 현재 가입을 승인하는 발견된 네트워크안에서 적어도 한개의 지그비 라우터가 있는지 아닌지를 검증할 것이다.


### Network Formation

 응용층의 요청을 받으면, NWK층은 장비를 지그비 코디네이터로서 설립할 수 있다.
 장비는 지그비 코디네이터로 수행하기 위해서 FFD이어야 한다.
 네트워크 형성의 첫 번째 단계는 선택된 개수의 채널에서 MAC 관리 서비스를 사용하여 ED 스캔을 수행한 후 액티브 스캔을 수행하는 것이다.
 스캔 요청은 NLME에 의해 MLME로 발급된다.
 스캔 결과에 기초하여, NWK층은 주파수 채널과 유일한 PAN 식별자를 선택한다.
 기존 네트워크 넘버가 가장 적은 첫 번째 채널은 새로운 네트워크에서 사용될 적합한 주파수 채널로 간주된다.
 지그비 코디네이터의 NWK층은 네트워크 주소와 동일한 MAC 짧은 주소로 0x0000을 선택한다.
 지그비 코디네이터의 첫 번째 일은 MAC 관리 서비스를 사용하여 슈퍼프레임을 구성하는 것이다.
 

### Establishing the Device as a Router

 지그비 라우터는 데이터 프레임을 라우팅하는 것과 경로 발견 그리고 경로 보수에 대한 책임이 있다.
 라우터는 자체 슈퍼프레임을 설립할 수 있고 다른 장비로부터 네트워크 가입에 대한 요청을 받아들일 수 있다.
 장비를 라우터로서 설립하는 요청은 응용층에서 NLME-START-ROUTER.request 프리미티브를 사용하여 nwk에게 주어진다.
 라우터가 자체 슈퍼프레임을 형성할 수 있다고 간주하면서, 이 프리미티브는 비콘오더,슈퍼프레임 오더 그리고 배터리라이프확장(BLE)
 와 같은 슈퍼프레임 매개변수들을 포함하다.
 NWK층은 MAC 층에게 슈퍼프레임 구성을 만들거나 업데이트 하도록 요청한다.
 
 
### Joining and Leaving Network

  어떤 장비에서든, 만약 mac 특성 macAssociationPermit가 true로 설정된다면, 장비는 연결 요청을 받아 들일 것이다.
  지그비 코디네이터나 라우터의 NWK 레이어는 MLME에 macAssociationPermit의 값을 정해진 기간 동안 TRUE로 설정해 달라고 요청함으로써
  다른 기기가 네트워크에 가입할 수 있도록 할 수 있다.
  이 기간은 허가 기간으로 알려져 있다.
  
  다음 상위 계층은 장비를 기존 네트워크에 라우터 혹은 종단 장비로서 가입하게끔 
  nwk층에게 요청하기 위해 NLME-JOIN.request 프리미티브를 사용한다.
  이 프리미티브는 또한 장비가 이전에 이 네트워크에 연결되어 있는지 여부를 명확히 한다.
  
  자식은 길이와 스캔의 타입을 결정한다.
  자식의 MAC층은 NWK층에게 발견된 네트워크의 목록을 전달한다.
  그리고 자식은 알맞은 부모를 선택한다.
  부모가 연결을 허용하고 부모와 자식 간 링크 비용이 3보다 작으면 부모는 알맞은 것으로 간주된다. 
  만약 1개 이상의 적합한 부모가 있다면, 지그비 코디네이터로부터 가장 적은 깊이 값을 가진 부모가 선택된다.
  적합한 부모를 고르는 즉시, 자식의 NWK층은 MLME-ASSOCIATE.request 프리미티브를 사용하여 연결 절차를 시작한다.
  
  부모가 연결 요청을 받으면, 부모는 이웃 테이블을 확인 함으로서 자식이 이미 부모 네트워크에 가입된 장비의 요청이 아닌지를 결정할 것이다.
  만약 자식이 이웃 테이블에 없다면 자식은 유일한 네트워크 주소를 받을 것이다.
  각 부모는 자식에게 할당 가능한 제한된 수의 주소를 가지고 있다.
  만약 가입 요청이 허가되면, 부모는 이웃 데이블에 장비를 자식으로서 추가함으로써 업데이트 할 것이다.
 
  만약 장비가 이전에 이 부모에 연결되었다면, NWK rejoin 요청 명령이 사용될 것이다.
  부모가 현재 어떤 새로운 아이를 받아들이지 않더라도 자식은 부모에 다시 들어갈 수 있다.
  
  네트워크에 가입하는 다른 방법으로는 직접 강비이 있다.
  직접 가입은 부모가 이미 자녀의 64비트 주소로 미리 구성했을 때 사용된다.
  이 경우, 부모가 이미 정해져 있기 때문에 자식이 적합한 부모를 찾을려고 시도하지 않는다.
  부모는 자식의 64비트 주소가 이미 이웃 테이블의 목록인지 확인하기 위해서 이웃 테이블을 검색함으로서 가입을 시작할 것이다.
  만약 이웃 테이블에 존재하면, 부모로 부터 어떠한 추가적인 행동은 없다.
  만약 주소가 이웃 테이블에 없다면, 부모는 테이블이 꽉 차지 않는다면 테이블에 새로 추가할 것이다.
  
  직접 가입에서 부모가 자식을 컨택하지는 않지만, 자식은 부모/자식 관계를 설립하기 위해서 고립 절차를 시작할 책임이 있다.
  
  네트워크에서 자식을 지우는 것은 자식 혹은 부모에서 시작될 수 있다.
  mac 층 해제는 장비를 네트워크에서 지울 때 사용된다.
  장비가 네트워크를 떠날 때, 모든 자식은 이와 같이 네트워크에서 제거 될 것이다.
  이 지워진 자식은 어플리케이션 시나리오에 따라 이 네트워크나 다른 네트워크에서 새 부모에 가입할 수 있다.
  
  만약 자신이 네트워크에서 나갈려는 자식이 지그비 코디네이터나 라우터 라면, nwk층 탈퇴 명령 프레임은 목적지 주소로 브로드 캐스팅 주소인 0XFFFF를
  선택함으로서 전체 네트워크에 브로드캐스팅 된다.
  탈퇴 명령을 브로드캐스팅하는 이유는 이 특정 라우터 또는 코디네이터에 의존하는 모든 장치가 경로를 업데이트하거나
  필요한 경우 새 부모를 찾아야 한다는 것을 알 수 있도록 하기 위한 것이다.
  대조적으로 지그비 종단 장비는 탈퇴 명령을 오직 부모에게 유니캐스트 한다.
  두 경우에서 모두, 응용 층은 nwk이 탈퇴 절차를 시작하도록 NLME-LEAVE.request를 사용한다.
  
  부모가 자식을 지우도록 결정한 경우, 탈퇴 요청 명령을 자식에게 유니캐스트한다.
  자식이 네트워크에서 성공적으로 제거된 후에, 부모는 이웃 테이블을 관련해서 업데이트한다.
  이전 아이의 주소는 APL 계층이 이 아이의 제거를 위해 NWK 계층에 주어진 NLME-LEAVE 요청 프리미티브에서
  주소를 재사용할 수 있는 경우에만 재사용할 수 있다. 
  만약 제거된 자식이 지그비 라우터일 경우, 자식은 목적지 주소를 0XFFFF와 같이 선택함으로서 탈퇴 명령을 브로드캐스트 할 것이다.
  

![image](https://user-images.githubusercontent.com/43804441/53301730-da972100-3899-11e9-9e49-c86809b16e79.png)


### Resetting the NWK layer

  위 그림 3.39 처럼 NWK 계층은 다음 상위 계층의 요청에 따라 재설정 작업을 수행한다.
  nwk층은 먼저 mac층을 리셋한다.
  mac 리셋 확인을 수신한 후에, nwk층은 모든 NIB 특성, 라우팅 테이블 그리고 경로 발견 테이블을 초기 값으로 초기화 한다.
  리셋 요청은 응용층에서 부터 NLME-RESET.request의 형태로 온다.
  nwk층은 응용층에게 NLME-RESET.confirm 프리미티브로 리셋 수행의 결과를 확인한다.
  장치는 초기 전원 가동 후, 가입을 시도하기 전과 네트워크를 떠난 후에 NWK 계층 재설정을 수행한다.
  
### shynchronization

  장비는 동기화 하거나 또는 지그비 코디네티어/라우터 로 부터 온 펜딩 데이터를 압축 해제하기 위해서 동기 절차를 사용할 수 있다.
  비콘 사용 네트워크와 비 비콘 네트워크 두 가지 경우가 있다.
  
  
![image](https://user-images.githubusercontent.com/43804441/53301819-b6880f80-389a-11e9-9c28-e72f5ea04160.png)  
  
  
  그림 3.40은 두 경우에 대한 순서를 보여준다.
  macAutoRequest의 값은 MAC에 데이터 요청 명령을 자동으로 생성 및 전송하도록 요청하는 TRUE로 설정된다
  APL 계층은 NLME-SYNC.request를 사용하여 NWK 계층을 요청하여 동기화 및 데이터 요청 프로세스를 시작한다. 
  동기화 결과는 NLME-SYNC.confirm에 의해 APL 계층에 전달된다.


![image](https://user-images.githubusercontent.com/43804441/53314908-1b2b8480-3904-11e9-86dc-3adfbc564b4b.png)

 
## The NWK Layer frame formats

  먼저 일반적인 프레임 포맷부터 보자.
  
  일반적인 NWK층 프레임은 위 그림 3.41에서 보여진다.
  첫번째 필드는 프레임 제어 필드이다.
  프레임 타입은 nwk 데이터 프레임인지 명령 프레임인지를 결정한다.
  지그비 표준은 시간이 지날수록 진화하고 특별한 장비에 사용되는 지그비 프로토콜 버전은 nwkcProtocolVersion 에 저장된다.
  nwkcProtocolVersion 의 값은 항상 nwk 프레임의 프로토콜 버전 부필드에 복사된다.
  
  
  발견 경로 부필드는 이 프레임을 위한 라우팅 옵션을 결정한다.
  만약 발견 경로 부필드가 억제 또는 활성화 되기로 설정되어 있고 경로가 목적지로 이미 설립되었다면, 프레임은 다음 홉으로 전달될 것이다.
  그러나 만약 목적지로의 경로가 설립되어있지 않고 발견 경로 부필드가 억제 되었다면, 장비는 새 경로 발견을 시작하지 않을 것이다.
  프레임은 버려지거나 경로가 사용가능할 때 까지 버퍼 될 것이다.
  만약 발견 경로가 활성화되고 목적지로의 경로가 없다면, 경로 발견은 시작될 것이다.
  마지막으로, 경로 발견이 강제로 경로 발견을 하도록 설정되어 있는 경우, 
  이미 목적지까지 설정된 경로가 있더라도, 이 프레임을 전송하기 위한 경로 발견이 시작된다.
  지그비 프로에서, 강제 경로 발견 옵션은 발견 경로 부필드에 의해 지워진다.
  
  
  만약 멀티캐스팅 프래그가 1로 설정되면, 프레임은 멀티캐스트에 의해 보내진다.
  보안 부필드가 1로 설정되면 nwk층 보안이 사용가능하다는 것이다.
  소스 경로 부필드는 소스 경로 부프레임 필드가 프레임에 포함되었다면 1로 설정된다.
  소스 라우팅은 패키싀 송신자가 패킷이 네트워크를 통과해야하는 경로를 지정할 수 있는 기술이다.
  소스 경로 부프레임은 소스 라우팅에서 프레임을 전달하는데 사용되는 노드들의 16비트 짧은 주소들의 목록을 포함한다.
  전달 인덱스는 소스 장비에서 0으로 설정되고 프레임이 라우터에 의해 전달될 때마다 증가한다.
  전달 수는 프레임 전달이 시도된 수이다.
  
  nwk층 IEEE 주소 부필드가 1로 설정되었다면, NWK층 프레임에서 64비트 IEEE주소를 포함한 옵션을 가질 수 있다.
  발신지와 목적지의 16비트 네트워크 주소는 프레임에 항상 포함된다. raduis 필드는 프레임이 가질 수 있는 최대 홉의 수를 결정한다.
  만약 radius 매개변수가 제공되어지지 않았다면, nkw층 헤더의 radius 부필드는 wkMaxDepth 속성의 2배로 설정된다.
  순서 번호는 장비에 의한 전송의 순서를 유지하는데 도움이 된다.
  순서 번호의 값은 새 프레임이 전송될 때마다 증가한다.
  
  멀티캐스트 제어 필드는 오직 프레임이 멀티캐스트일 때만 존재한다.
  멀티캐스트 모드 부필드는 프레임이 논멤버 혹은 멤버 모드 장비 중 어떤 것에 의해 보내지는지를 결정한다.
  논멤버 radius 부필드는 논멤버 장비에 의해서 멀티 캐스트 프레임이 재브로드 되는 수를 제한한다.
  
  논멤버 radius는 프레임이 논멤버 장비에 의해 재 브로드 될때마다 감소한다.
  논멤버 radius 부필드가 0이 되면, 프레임은 더이상 논멤버 장비에 의해 재 브로드 될수 없다.
  그러나 만약 논멤버 radius의 내용이 0x07이 되면, 제한 없이 논멤버 장비에 의해 재브로드 될 수 있다.
  멤버 장비가 프레임을 (재)브로드 할때마다 최대 논멤버 부필드의 내용이 논멤버 radius 부필드로 복사 될 것이다...???
  

![image](https://user-images.githubusercontent.com/43804441/53316968-233bf200-390d-11e9-9504-dbb073695eab.png)

  
  데이터와 명령 프레임 포맷은 그림 3.42에서 보여진다.
  라우팅 필드는 프레임 제어와 nwk 페이로드 사이의 필드들의 결합이다.
  nwk 명령은 테이블 3.12의 목록 중 하나 이다.
  각 명령은 nwk명령 식별자로 알려진 8비트 수에 의해 식별된다.
  nwk 명령 식별자와 명령 페이로드는 nwk 프레임 페이로드를 형성할 것이다.
  
  
![image](https://user-images.githubusercontent.com/43804441/53318277-140b7300-3912-11e9-8cce-5cfb05c13bca.png)


  경로 요청 명령은 경로 발견이나 경로 보수 절차에 사용된다.
  만약 멀티캐스트 부필드가 1로 서정되면,이 경로 요청은 멀티캐스트 경로 발견의 부분이다.
  경로 보수 부필드는 이 경로 요청 명령이 경로 발견 대신 경로 보수로 확인되면 1로 설정된다.
  
  경로 보수를 경로 발견과 구분하기 위한 이유는 경로 발견은 항상 발신지 장비에 의해 시작되기 때문이다.
  이와는 대조적으로, 경로 수리는 소스 장치를 대신하여 메시지를 전달하려고 시도했지만 
  다음 홉으로 프레임을 보내려고 시도하는 동안 링크 실패에 직면했던 라우터 장치에 의해 시작된다.
  경로 요청 식별자는 발신지 장비에 의해 발급된 각 경로 요청을 확인할수 하기 위한 8비트 순서 번호이다.
  발신지 장비는 새 경로 요청을 생성할 때마다 경로 요청 식별 필드의 내용을 증가시킨다.
  경로 검색 중에, 소스 장치를 대신하여 경로 요청을 브로드캐스트하는 라우터는 경로 요청 식별자를 변경하지 않고 유지한다.
  경로 검색의 목적은 경로 요청 명령 프레임에 제공된 목적지 주소의 경로를 찾는 것이다.
  
  경로 요청 명령은 발신지부터 목적지까지의 경로비용을 계산하기위해 경로 비용 필드를 가진다.
  경로 비용 필드는 발신지부터 목적지까지 최적의 경로를 결정하는데 사용될 것이다.
  목적지 장비는 같은 경로 요청 프레임을 다양한 경로로 받을 것이다.
  목적지 장비는 가장 좋은 경로로 발신지 장비에게 응답을 되돌려 보낼 것이다.
  
  지그비 프로에서는 경로 요청 명령 안 경로 비용 필드 뒤에 하나의 필드가 더 있다.(IEEE 목적지 주소)
  또한 지그비 프로에서 명령 필드의 3-4비트는 다대일 경로 요청을 지원하기 위해 사용된다.
  만약 2-3 비트의 값이 0이라면, 경로 요청은 다대일 경로 요청이 아니라는 뜻이다.
  마지막으로 만약 명령 옵션 필드의 비트 2-3의 값이 2라면 경로 요청은 다대일이고 소싱자는 경로 기록 테이블을 지원하지 않는다.
  
  다음 NWK층 명령은 경로 응답 명령이다.
  이 경로 응답 명령은 목적지 장비에서 발산지 장비로 경로 요청 명령의 응답으로서 보내진다.
  명령 옵션 필드는 명령 경로 요청 명령의 명령 옵션 필드와 비슷하다.
  경로 요청 식별자는 경로 요청 명령 프레임과 같다.
  발신지 장비가 경로 응답 명령을 목적지로부터 되돌려 받을 때, 발신지 장비는 이 경로 응답 명령이 발신지 장비 경로 요청의 한 응답인 것을 알 것이다.
  발신자 주소 필드는 발신지 장비의 16비트 주소를 포함합니다.
  응답자 주소 필드는 경로 요청 명령 목적지 주소에 의해 제공된 16 nwk 주소를 포함한다.
  발신지 장비는 항상 응답 장비로의 겨로를 설립하기 위해 시도한다.
  경로 응답 명령의 경로 비용은 전체 경로 비용을 계산하는데 사용된다.
  지그비 프로에서 경로 비용 필드 다음에, 발신자 IEEE 주소와 응답자 IEEE주소 2가지의 필드를 추가적으로 가진다.
  
  
  경로 에러 명령은 명령은 특정 목적지 주소로 프레임을 릴레이하는 동안 소스 장비에 오류를 알리는 데 사용된다.
  에러 코드 필드의 에러 코드는 라우팅 에러의 이유를 결정하는데 사용될 수 있다.
  라우팅 에러의 이유의 예로 트리 링크 실패, 라우팅 용량 부족, 낮은 배터리 레벨이 있다.
  후자에서, 중계 장치는 배터리 잔량이 매우 낮기 때문에 라우터 역할을 할 수 없다.
  지그비 프로에서 이 명령은 네트워크 상태 명령으로 이름이 바뀌며 오류 코드를 상태 코드라고 한다.
  지그비 프로의  네트워크 상태 명령은 경로 오류 명령의 모든 오류 코드와 PAN 식별자 업데이트와 같은 사고를 보고하기 위한 추가 코드를 포함하고 있다.
  
  
  장비는 장비가 네트워크를 떠나기를 원하거나 다른 장비로 부터 네트워크 탈퇴를 요청 받았을 경우 탈퇴 명령을 전송할 것이다.
  만약 장비가 스스로 네트워크를 떠나려고 한다면, 탈퇴 명령의 요청 부 필드는 0이다.
  반면 다른 장비로 부터 요청되어 네트워크를 떠난다면 1로 설정된다.
  장비는 부모를 떠날 것이지만 네트워크의 다른 장비에 재 가입한다. 만약 장비가 네트워크에 재가입하려고하면, 재가입 부필드는 1로 설정된다.
  마지막으로 네트워크를 떠나는 장비가 부모이고 자식을 지운다면, 명령의 부필드는 1로 설정된다.
  네트워크를 떠나는 장치가 부모이고 명령의 제거 자식 부필드가 하나로 설정된 경우, 부모가 떠날 때 이 부모의 모든 자녀는 네트워크에서 제거된다.
  
  
  경로 기록 명령은 설립된 경로를 통해 이 명령프레임을 전달하는 모든 장비의 주소를 기록하기 위해서 전달된다.
  전달 카운터 부필드 값은 프레임이 전달 된 수와 같다.
  이 프레임을 전달한 모든 장비의 짧은 주소는 전달 목록에 유지된다.
  목적지 장비를 제외한 장비가 이 명령을 받을 때, 
  장비는 유니캐스트를 통해 다음 홉으로 전달하기 전에 자신의 16비트 짧은 주소를 전달 목록에 추가하고 전달 카운터를 증가시킨다.
  다음 홉의 주소는 라우팅 테이블에서 제공된다.
  
  장비가 네트워크와의 연결을 잃어버렸을 경우, 재가입 요청 명령을 사용하여 원래 부모이외의 장치를 통해 네트워크에 재가입 할 수 있다.
  재가입 요청 명령에서 장비는 자신의 기능 목록을 제공한다.
  이는 MAC 계층 연결 요청에서 제공하는 기능 목록과 유사하다(그림 3.25). 
  재가입 요청을 수신하는 장치는 재가입 응답 명령을 사용하여 응답한다.
  만약 새 부모가 새 자식을 받아들일 수 있다면, 재가입 응답 명령의 짧은 주소 필드는 자식에게 할당된 새 16비트 주소를 포함할 것이다.
  재가입 상태 필드는 그림 3.25의 연결 상태 필드와 비슷하다.
  
  지그비 프로에서 NWK층은 3가지 추가적인 명령을 가지는데 2006지그비에는 없던 것들이다.
  첫째로 링크 상태 명령이다.
  각 라우터는 다른 이웃 라우터에게 링크 비용을 통신하기 위해서 링크 상태 명령을 사용할 수 있다.
  두번째는 네트워크 보고 명령이다. 이것은 nwkManagerAddr에서 지정된 장치에 PAN ID 충돌 및 채널 상태 등의 네트워크 이벤트를 보고하는데 사용된다.
  마지막 명려은 네트워크 업데이트 명령이다.
  이 명령은 브로드캐스트 구성 변경을 위해 지정된 장치(nwkManagerAddr 속성으로 식별)에 의해 사용된다. 
  이 명령의 형식은 ZigBee 규격에 수록되어 있다.
  
  
