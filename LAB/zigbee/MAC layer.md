

# MAC Layer

  MAC는 물리 계층과 MAC 위의 상위 계층 사이에서 인터페이스를 제공합니다.
  지그비 네트워크에서 이 다음 상위 계층은 NWK 층입니다.
  IEEE 802.15.4는 특별히 ZigBee 애플리케이션을 위해 개발되지 않았으며, 다음 상위 계층은 모든 네트워킹 프로토콜 계층이 될 수 있다.
  이 글에서 MAC 서비스는 직비 NWK층의 인터페이싱을 위해 논의 될 것이다.
  
![image](https://user-images.githubusercontent.com/43804441/52327615-11fb7600-2a30-11e9-8322-3d89d99fe7fc.png)
  
    위 그림 3.6은 맥 부계층 모델을 보여준다. 
    물리 계층과 비슷하게 맥 계층은 MAC Layer Management Entity (MLME) 라고 불리며 MAC 관리 서비스를 위한 관리체를 포함합니다.
    MLME는 NWK층의 NLME와 상호작용합니다.
    
    또한 MAC는 MAC-PIB라 불리는 자신만의 데이터베이스를 같는다.
    모든 MAC 변수들은 a라는 일반적인 접두사를 가진다. MAC 속성은 일반적으로 mac접두사를 가진다.
    MAC-PIB의 크기는 PHY-PIB보다 크다.  MAC 변수와 속성의 표는 802.15.4 표준 문서에 포함된다.
    
 
## Beacon-Enabled Operation and Superframe Structure ( Beacon-Enabled 작동 및 슈퍼프레임 구조 )

    beacon-enabled 네트워크의 이점 중 한가지는 보장된 시간 간격(GTSs)의 가용성이다.
    비콘 프레임들은 비콘들과 GTSs의 수 사이의 시간 간격과 같은 비콘정보를 포함하는 MAC 프레임들이다.
    비콘 포맷은 밑에서 설명할 것이다.


![image](https://user-images.githubusercontent.com/43804441/52329560-76b9cf00-2a36-11e9-9492-bdc615c74f96.png)


    beacon-enabled 수행에서 슈퍼프레임 구조를 사용하는 것이 가능하다.
    슈퍼프레임은 위 그림과 같은데, 두개의 비콘 프엠으로 둘러 싸여 있다.    
    슈퍼프레임 구조의 사용은 802.15.4표준에서 선택적이다. 
    슈퍼 프레임에는 경합 엑세스 주기 CAP, 경합 없는 주기 CFP, 비활동기간의 3가지 타입의 기간이 있다.
    
    CAP 동안 송신하고자 하는 모든 장치는 주파수 채널에 접근하기 위해 CSMA-CA 메커니즘을 사용해야 한다
    주파수 채널은 같은 네트워크 상의 모든 장비를 동일하게 사용가능합니다.
    사용 가능한 채널을 사용하여 시작하는 첫 번째 장치는 현재 전송이 완료될 때까지 자체적으로 유지합니다.
    장치가 사용 중인 채널을 발견하면 임의의 시간 동안 꺼지고 다시 시도한다.
    이것은 대규모 네트워크에서 대부분의 장치에 대한 채널 액세스 메커니즘일 가능성이 가장 높다.
    MAC 제어 프레임은 CAP 동안 전송된다.
    
    CAP 중에는 장치가 필요할 때 주파수 채널을 사용할 수 있다는 보장이 없다.
    대조적으로 CFP는 특별한 장비를 위한 타음 슬롯을 보장하고 그래서 장비는 채널 접속을 위한 CSMA-CA를 사용할 필요가 없다.
    이는 기기가 채널을 사용할 수 있을때까지 무작위적이거나 잠재적인 긴 시간 주기를 기다릴 필요가 없는 짧은 지연 어플리케이션에 좋은 선택이다.
    CSMA-CA는 CFP와 함께 사용할 수 없다.
    
    CAP와 CFP의 결합은 활동 주기로 알려졌다. 
    활동 주기는 16개의 동일한 타음슬롯으로 나누어져 있다. 비콘 프레임은 항상 첫번째 타음 슬롯의 시작 부분에서 시작한다.
    CFP에서 7개의 GTSs가 있을 수 있다. 각 GTS는 하나 또는 더 많은 타임슬롯을 차지한다.
    
    슈퍼프레임은 선택적으로 비활동 주기를 가질수 있다. 비활동 주기에 장비는 전력 절약 모드가 될 수 있다.
    전력 절약 모드에서 코디네티어는 배터리 에너지 절약을 위해 송수신 회로를 끌 수 있다.
    
    슈퍼 프레임의 구조는 코디네이터에 의해 정의되고 MLME-START.request primitive 를 사용하여 NWK 층에 의해 구성된다.
    두 개의 연속적인 비콘 사이의 지속시간인 비콘 간격 (BI)은 다음 공식을 사용한 macBeaconOrder(BO) 속성과 aBaseSuperframeDuration 변수
    에 의해 결정된다.
    

![image](https://user-images.githubusercontent.com/43804441/52334805-fac68380-2a43-11e9-867a-651f066755ea.png)

    예를 들어 960의 Base Superframe 기호 구성 및 2의 macBeaconOrder를 지정하면 신호 간격이 3840 기호로 지정됨
    macBeaconOrder는 신호 사용 네트워크에서 0부터 14까지의 값을 가질 수 있다. 
    macBeaconOrder의 값이 15로 설정된 경우, 네트워크는 nonbeacon-enable인 것으로 간주되며, 어떤 수퍼프레임 논의도 적용되지 않는다
    
    비슷하게, 슈퍼프레임의 활동주기의 길이인 슈퍼프레임 기간 (SD)는 다음 공식으로 계산된다. 

![image](https://user-images.githubusercontent.com/43804441/52334985-935d0380-2a44-11e9-8669-84918cee2285.png)

   여기서 SO는 macSuperframeOrder 특성의 값이다. 슈퍼프레임 기간은 비콘 기간을 초과할 수 없다. 그래서 SO의 값은 항상 BO보다 같거나 작다.
   
   nonbeacon-enable 네트워크에서 ( BO가 15일 때) 코디네이터는 네트워크의 장치에서 비콘 요청 명령을 수신하지 않는 한 비콘을 전송하지 않는다.
   비콘 요청 명령은 코디네이터를 찾기 위해 장치에 의해 사용된다. 비콘 요청 명령의 포맷은 밑에서 보여질 것이다.
   nonbeacon-enabled 네트워크에서 PAN 코디네이터는 macSuperframeOrder의 값을 15로 설정한다.
   
  
   beacon-enabled 네트워크에서, PAN 코디네이터 뿐 아니라 어떤 코디네이터든, 비콘을 보내거나 자체 슈퍼프레임을 만들기 위한 옵션을 가지고 있다. 
   그림 3.8은 같은 네트워크 상의 PAN 코디네이터와 다른 코디네이터 모두 비콘을 보낼 때 요구되는 시간을 보여준다.
   코디네이터는 오직 PAN 코디네이터 슈퍼프레임의 비활동 주기동안에만 자체 비콘 전송을 시작할 수 있다.
   PAN 코디네이터 비콘은 수신된 비콘으로 불려진다.
   다른 어떤 코디네이터의 비콘은 전송 비콘으로 알려져 있다.
   두 슈퍼프레임의 활동 주기는 동일한 길이를 가져야 한다.
   PAN 코디네이터이외의 다른 코디네이터는, 오직 자체 슈퍼프레임의 시작을 특정하는 비콘만 보내고, 그리고 슈퍼프레임의 끝은 PAN 코디네이터의 슈퍼프레임의 끝과 동일할 수 있다.
   
   만약 장비가 긴 기간의 시간 동안 자체 GTS를 사용하지 않는다면, 해당 GTS는 만료될 것이고 코디네이터 다른 장치에 특정 GTS를 할당 할 수 있다.
   GTS 만료를 초래하는 비활동 주기는 항상 슈퍼프레임 길이의 두배이다. 이 정수 배의 값은 macBeaconOrder에 따른다.
   
![image](https://user-images.githubusercontent.com/43804441/52517841-cc83b680-2c84-11e9-8204-615796489c10.png)

![image](https://user-images.githubusercontent.com/43804441/52517845-e9b88500-2c84-11e9-9c3f-be2755353b41.png)

  
  예를 들어, 만약 4번의 연이은 슈퍼프레임 동안 7의 macBeaconOrder의 장비가 자체 GTS를 사용하지 않는다면, 그 GTS는 만료될 것이다.
  
## THE Interframe Spacing  
  
![image](https://user-images.githubusercontent.com/43804441/52517872-7a8f6080-2c85-11e9-9e24-f59475a9a508.png)

   
  한 장비에서 다른 장비로 데이터를 전송하는 동안, 송신 장비는 수신장비가 다음 프레임이 도착하기 전에 
  수신된 프레임을 처리할 수 있도록 연속적인 프레임전송 사이에 잠시 기다려야만 한다.
  이는 IFS,프레임 공간이라고 알려져 있다.
  IFS의 길이는 전송되는 프레임의 사이즈에 달려있다.
  aMaxSIFSFramesSize (a MAC constant with default value of 18 octets)와 동일하거나 적은 사이즈의 MPDU들은 작은 프레임으로 고려된다.
  긴 프레임은 aMaxSIFSFramesSize의 크기를 초과하는 MPDU이다.
  
  짧은 프레임이후의 대기 기간은 shortIFS (SIFS)라고 불리운다. SFIS의 최소 값은 macMinSIFSPeriod이다.
  비슷하게 긴 프레임은 LongIFS(LIFS)이고 macMinLIFSPeriod의 최소 값을 가진다.  
   macMinSIFSPeriod과 macMinLIFSPeriod은 12개 및 40개의 기호이다.
   
   그림 3.9는 두 가지 시나리오의 인터프레임공간을 보여준다.
   첫 번째에서 메세지는 인정되며, 프레임 길이에 따라서 수신된 프레임과 다음 프레임 사이의 대기 시간이 SIFS or LIFS이다.
   프레임 전송 및 수신 프레임의 수신에 따른 시간을 t(ACK)로 표시한다.
   만약 확인이 필요하지 않는다면, 최소 인터프레임 간격은 프레임이 전송되는 순간부터 시작된다.
   

## CSMA-CA

    
   CSMA-CA는 802.15.4에 의해 지원되는 채널 접근 매커니즘이다.
   CSMA-CA에서, 장비가 송신을 원할 때면, 채널이 다른 장비에 의해 사용 되지 않는 것을 보장하기 위하여 CCA를 수행한다.
   장비는 자체 신호로 전송을 시작하다. CSMA-CA에 관한 간단한 내용은 내 깃허브의 LAB 폴더의 다른 MD파일을 참조하면 확인이 가능하다.
   
   비콘 전송외에 CSMA-CA를 사용하지 않고 장비가 채널에 접근하는 경우는 2가지가 더 있다.
   
        * contention-free period (CFP)동안 채널에 접근할 때.
        
        * 데이터 요청 명령을 승인한 직후 즉시 전송한다. 즉, 만약 장비가 코디네이터로부터 데이터를 요청하는 경우, 코디네이터는
        경쟁 접근 기간 (CAP)동안에도 이 두 송신간 CSMA-CA를 수행하지 않고 바로 그 후에 데이터를 송신하다.
        
   CSMA-CA에는 슬롯과 언슬롯 두가지 타입이 있다.
   슬롯 CSMA-CA는 슈퍼프레임 구조가 있는 동안 CSMA-CA를 수행하는 것을 말한다.
   슈퍼프레임은 활동 기간을 16개의 동일한 시간 슬롯으로 나눈다. CSMA-CA알고리즘의 백오프 기간은 특정한 시간 슬롯으로 맞추어 져야한다.
   
   언슬롯 CSMA-CA알고리즘은 슈퍼프레임 구조가 없을 때 사용된다.
   결과적으로 백오프 슬롯 정렬은 필요가 없다. nonbeacon-enabled 네트워크는 항상 언슬롯 CSMA-CA 알고리즘을 채널 접근으로 사용한다.
   
   만약 CCS가 사용 중인 채널을 표시하면, 장비는 랜덤한 시간 주기동안 백오프 될 것이고 다시 시도할 것이다.
   이 슬롯과 언슬롯 CSMA-CA의 랜덤한 백오프 주기는 단위 백오프 기간의 정수 배이다. 
   이 단위 백오프 기간은 aUnitBackoffPeriod (a MAC constant) 기호와 같다.
   
   
![image](https://user-images.githubusercontent.com/43804441/52518288-c47b4500-2c8b-11e9-84a0-56cf47e823ba.png)

   
   
   그림 3.10은 CSMA-CA 알고리즘의 흐름도를 보여준다.
   알고리즘의 첫 단계에서, 결정은 슬롯 혹은 언슬롯 CSMA-CA를 사용하여 만들어진다.
   CSMA-CA알고리즘에서는 3가지 변수가 사용된다.
   
        the back-off exponent (BE), 
        the number of back-offs (NB),
        the contention window (CW) length.
   
   알고리즘이 사용중인 채널을 마주할 때마다, 랜덤한 시간 동안 백오프 되고 BE는 이 랜덤한 기간동안 허용된 범위를 결정한다.
   
   이 랜덤한 백오프는 단위 백오프 기간에 의한 0과 2^BE-1 사이의 정수의 배이다.

![image](https://user-images.githubusercontent.com/43804441/52518293-d2c96100-2c8b-11e9-99b0-b5c167913b51.png)
   
   BE의 초기 값은 언슬롯 CSMA-CA 채널 접근의 macMinBE와 동일하다.
   슬롯 CSMA-CA에서, 슈퍼프레임 구조의 배터리 라이프 확장(BLE) 옵션의 선택은 BE 값에 영향을 미친다.
   만약 BLE옵션이 활성화되면, 코디네이터는 배터리 절약을 위하여 비콘 프레임 전송에 따른 macBattLifeExtPeriods와 같은 기간후에 수신기를 종료한다.
   이 경우 백오프 기간의 범위는 2와  macMinBE의 더 작은 값으로 최소화 된다.
   
   BE = min(2,macMinBE)
   
   만약 BLE 옵션이 선택되지 않으면, 코디네이터는 전체 CAP동안 활성화 되고, BE의 값은  (언슬롯 CSMA-CA와 비슷하게) macMinBE와 같다.
   BE의 값은 CCA가 수행되고 채널이 사용 중일 때마다 증가한다. 그러나 BE의 값은 macMaxBE를 초과할 수 없다.
   
   NB는 장비가 백오프되고 채널 접근 매커니즘을 재시도하는 횟수를 추적하는 카운터이다.
   알고리즘의 시작에서 NB는 0이고 장비가 사용 중인 채널을 만나 백오프 될 때마다, BE는 증가한다.
   만약 NB가 macMaxCSMABackoffs에 도달하고 채널이 여전히 접근이 불가능하면, CSMA-CA 알고리즘은 종료하고 NWK층으로 채널 접근 실패를 보고한다.
   
   경쟁 윈도우 CW 변수는 전송 시작 전에 채널을 사용할 수 있어야 하는 백오프 기간을 결정한다.
   예를 들어, 만약 CW가 2와 같다면 기기는 2회 연속적인 백오프로 인해 가용 채널이 생긴 후에만 전송을 시작한다.
   CW는 오직 슬롯 CSMA-CA 알고리즘에서만 사용된다.
   
   만약 전송이 허용된 시간동안 완료되지 못 한다면, MAC 다음 CAP이 시작될 때까지 기다리고 CSMA-CA채널 접근 알고리즘을 다시 시도한다.
   
   
### Hidden and Exposed Node Problems
    
   csma-ca 알고리즘의 한가지 취약점은 숨겨진 지국 문제이다.
   이 것은 lab 폴더의 다른 md 파일에서 확인이 가능하므로 해석은 넘어가도록 하겠다.
    
   또 다른 취약점인 노출된 지국 문제 역시 넘어가도록 하겠다.
    
    
    
## MAC Service

   MAC 계층은 MAC 데이터 서비스와 MAC 관리 서비스, 두 가지의 서비스를 제공한다.
   MAC 데이터 서비스는 MAC Common Part 부계층 SAP( MCPS-SAP)를 통하여 NWK층 데이터 객체인 NLDE에 의하여 접근될 수 있다.
   MAC 관리 서비스는 MLME-SAP를 통하여 접근된다.
   
   전기능 장비FFD는 MAC 데이터 서비스 전체를 구현해야 하지만 FFD에 대해서는 선택사항인 MAC 관리 서비스에는 일부 기능이 있다.
   MAC 데이터와 관리 서비스 모두에서 FFD에는 필요하지만 기능 감소 장비(RFD)에는 선택적인 기능이 다수 존재한다.
   RFD에 대한 옵션 기능(서비스 프라이머)은 IEEE 802.15.4 표준문서 [2]에 다이아몬드( ♦ )로 표시된다. 
    FFD와 RFD 모두에 대해 선택 가능한 기능은 별표로 표시한다.
   
   
