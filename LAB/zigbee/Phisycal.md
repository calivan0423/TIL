




## Energy Detection


장비가 메세지를 보낼려 할 때, 먼저 장비는 수신 모드가 되어 원하는 채널의 신호 에너지 레벨을 탐지하고 평가(예측)합니다.
이 것을 ED energy detection 이라고 합니다.
관심 대역의 신호 에너지는 8개의 신호 기간에 걸쳐 평균화 됩니다.
ED에서 수신자는 신호 타입을 탐지하려고 시도하지 않습니다. ; 단지 신호의 에너지 레벨이 평가됩니다.
즉, 신호가 관심 주파수 밴드를 차지한다면  ED를 수행하는 것으로 신호가 802.15.4의 표준인지 아닌지 드러낼 수 없습니다.

ED 절차는 수신기 감지 레벨과 가까운 에너지 레벨의 약한 신호를 감지할 수 없을 수 있습니다.
수신기 감도는 수신기가 1%미만의 패킷 오류율의 상태로 감지 및 변조할 수 있는 가장 낮은 신호 에너지 레벨입니다.
IEEE 802.15.4는 필요한 수신기 감도 레벨과 필요한 에너지 탐지 레벨 간에 10dB 차이를 허용합니다.
그래서 ED를 수행하는 수신기는 신호 에너지를 감지하고 필요한 감도 수준보다 10dB이상 낮게 측정할 수 있어야 합니다.

MAC 계층은 물리 계층에 ED를 수행하도록 요청 합니다. 
물리 계층은 8비트의 정수로 관심 주파수 채널의 에너지 레벨을 반환합니다.
에너지 정확도 수준은  +- 6dB 이상이어야 합니다.


## Carier Sense

ED와 비슷하게 Cairer Sense CS는 주파수 채널이 사용가능한지 확인하는 방법입니다.
CS에서 장비가 메세지를 전송 하려고 할 때 장비는 먼저 수신모드가 되어 원하는 주파수 채널에서 재연결 될 수 있는 가능한 신호의 유형을 탐지합니다.???
ED와 대조적으로 CS에서 신호는  복조를 통해  신호 변조 및 확산이 현재 장치에서 사용중인 물리 계층의 특성에 준수하는 지 확인힙니다.
만약 점유 신호가 IEEE 802.15.4 PHY를 만족하는 경우 장치는 채널이 에너지 레벨에 관계 없이 사용 중인 것으로 간주 할수 있스니다.


## Link Quality Indicator

  link quality indicator LQI는 순시기로 부터 수신된 데이터 패킷의 품질을 의미 합니다.
  수신된 신호 강도 received signal strength RSS는 신호의 품질을 측정하는데 사용될 수 있습니다.
  RSSS는 수신된 신호의 전체 에너지를 측정한 값입니다.
  신호 대 잡음 비 SNR은 신호 품질을 판단하는 다른 방법입니다. 
  일반적으로 SNR이 높을 수록 패킷 오류 가능성이 낮습니다.
  그래서 높은 SNR의 신호는 고품질 신호로 판단합니다. 링크 품질은 신호에너지를 판단할 수 있을 뿐 아니라 SNR을 판단할 수 있습니다.
  
  
  LQI 측정법은 각 수신 패킷 마다 수행됩니다. LQI는 적어도 8개의 고유한 레벨이 있어야 합니다.
  LQI는 MAC 계층에 보고되고 NWK와 APL 계층에서 모든 유형의 분석에 대해 사용 될 수 있습니다.
  예를 들어 NWK 계층은 보고된 네트워크 장치의 LQI 레벨을 이용하여 메세지를 라우터하는데 사용할 경로를 결정할 수 있습니다. 
  일반적으로 전체 LQI가 가장 높은 길을 통하여 대상에 메세지를 전송할 수 있습니다. 
  LQI는 메세지의 라우트 경로를 결정하는 요소 중 하나 일뿐 입니다.
  경로의 에너지 효율 고려사항 과 같은 다른 요소들도 경로 선택에 영향을 미칩니다.
  예를 들어 배터리 전력 장치는 링크 품질 면에서 우수한 위치에 있을 수 있지만 
  이 장치를 통해 메세지를 자주 전송하면 동일한 네트워크에 있는 나머지 장치보다 훨씬 더 발리 배터리가 방전 됩니다.
  

##  clear channel assessment

  csma/cs의 첫단계에서 MAC는 PHY에게 타 장비가 채널을 사용 중이 아닌 것을 확인 받기 위하여 CLEAR CHANNEL ASSESSMENT, CCA를 할 것을 요청 합니다.
  CCA는 PHY 관리 서비스의 부분입니다. CCA에서 ED혹은 CS의 결과는 주파수 채널이 사용될수 있는지 없는지 판단하기 위하여 사용될 수 있습니다.
  CCA 기간은 8 주기 여야 합니다...(??)
  
  다음 3가지 CCA 모드가 있고, IEEE 802.15.4. 호환 PHY는 다음 중 하나에서 작동 할 수 있습니다.
  
  
  1. CCA MODE 1
    : 이 모드에서 오직 ED의 결과만 고려됩니다. 만약 에너지 레벨이 ED 임계값을 초과 할 경우 채널은 사용중으로 간주됩니다.
      ED 임계값 레벨은 제조업체가 설정할 수 있습니다.
  
  2. CCA MODE 2
    : 모드 2 는 오직 CS 결과만 고려됩니다. 채널은 점유 신호가 CCA를 수행하는 장비의 PHY를 준수하는 경우에만 사용 중인 것으로 간주 됩니다.
    
  3. CCA MODE 3
    : 이 모드는 모드 1과 모드 2의 논리적인 결합 입니다. 즉, 모드 3에서 PHY는 다음 중 한 가지를 채널의 사용 여부로 간주 할 수 있습니다.
      A. 탐지 에너지 레벨이 임계값을 초과하거고 호환 반송파가 감지 될때. AND
      B. 탐지 에너지 레벨이 임계값을 초과하거나 호환 반송파가 감지 될때. OR
    
  장치가 사용할 CCA 모드는 PHY-PIB(PHY-PIB)에 PHY 속성(PyCCAMode)으로 저장됩니다. PHY-PIB는 아래 설명됩니다.
  
  
  
## THE PHY constants and attibutes

    상수는 프레임의 최대 크기 또는 이벤트의 지속시간과 같은 특성을 정의한다.
    프로토콜의 각 계층은 각자의 상수를 가집니다. PHY 계층은 모직 두 상수를 가집니다. 
    aMaxPHYPacketSize의 phy 상수는 PHY SERVICE DATA UNIT (PSDU)이 127을 초과할 수 없다는 것을 나타 냅니다.
    aTurnaoundTime의 상수는 송수신기가 송/수신 전환 할때 필요한 시간을 나타냅니다.
    이 상수에 기초하여 송수긴기는  12개 미만의 기호로 전환을 완료해야 합니다. 
  
  
![image](https://user-images.githubusercontent.com/43804441/51887249-56ef2f00-23d6-11e9-9cef-e281d7405496.png)

  
    물리 계층과 맥 계층에서 모든 상수는 일반 접두사 a를 가집니다.
    반면, 네트워크 계층과 응용 계층에서 상수의 접두사는 각각 nwk와 apsc 입니다. 이는 작동 중에는 바뀔 수 없습니다.

    속성은 작동 중 변할 수 있는 변수들 입니다. 
    물리 계층의 속성은 PHY PAN 정보 베이스( PHY-PIB)에 속해 있습니다. 이 속성들은 PHY 서비스를 관리하는데 필요 합니다. 
    PHY-PIB 속성 목록은 아래 표와 같이 있습니다.

![image](https://user-images.githubusercontent.com/43804441/51887214-3c1cba80-23d6-11e9-8f7c-bfa7ada16d9f.png)

    +십자 모양이 있는 속성은 읽기전용 속성입니다. 상위 계층은 오직 읽기 전용만 읽을 수 있지만 PHY계층은 변경도 가능합니다.
    *별 모양이 있는 속성은  읽기 전용의 특별 비트를 가지고 있습니다. 
    이러한 마크가 없는 속성들은 다음 상위 계층에 의해 읽거나 쓰일 수 있습니다. 오직 PHY 계층만이 읽기전용 비트를 바꿀 수 있습니다.
 
 
 ## PHY SERVICES
 
  물리 계층은 두 가지 타입의 서비스를 제공합니다. PHY 데이터 서비스와 PHY 관리 서비스 입니다.
  
  PHY 데이타 서비스는 라디오 채널을 통한  PHY Protocol Data Unit (PPDU) 전송과 수신을 가능하게 합니다.
  PHY는 Physical Layer Management Entity (PLME)라는 관리체를 포함하는데, 이는 아래 그림과 같습니다.
  PHY 관리 기능은 PLME에 의하여 호출 될 수 있습니다. PHY 데이타 서비스는 PHY Data SAP (PD-SAP)를 통하여 접근 됩니다.
  PHY 관리 서비스는 PLME-SAP를 통해 접근 됩니다.
  PLME는 또한 PHY PAN 기반 정보 (PIB)를 유지합니다.
  
  ![image](https://user-images.githubusercontent.com/43804441/51887743-21e3dc00-23d8-11e9-93fa-5999ab9914d7.png)


###  PHY DATA SERVICES

      전송될 필요가 있는 데이터는 항상 MAC Protocol Data Unit (MPDU)로서 제공됩니다. 로컬 MAC은 전송 요청을 발생 시키고, MPDU를 제공합니다.
      PHY는 전송을 시도하고 시도의 결과(성공 혹은 실패)를 MAC로 보고합니다. 실패 전송 시도의 이유는 다음과 같을 수 있습니다.
      
      1. 라디오 송수신기가 사용 불가이다.
      2. 라디오 송수신기가 수신모드이다. 라디오는 동시에 송수신 할 수 없다.
      3. 라디오 송수신기가 바쁜 상태이다. ( 이미 전송 중인 상태이다.)
      
      데이터가 라디오 송수신기에 의하여 수신될 때, PHY는 MAC에게 MPDU의 도착을 알립니다.
      PHY는 MAC에게 MPDU를 제공할 뿐 아니라 LQI정보도 전달합니다.
      
      
![image](https://user-images.githubusercontent.com/43804441/51888077-3674a400-23d9-11e9-9640-14ccbae034f2.png)
    
      위 그림은 한 장치에서 다른 장치로의 응용 계층에서부터의 데이터 전송 과정을 보여줍니다. 
      데이타는 항상 응용 계층으로부터 오지 않습니다. 예를 들어 데이터는 상위 계층에서 받지 않고 MAC 계층에서 발생할 수 있습니다. 
      위 그림의 과정에서 데이타는 다른 직비 장비 객체 (ZIGBEE DEVICE OBJECT , ZDO) 혹은
      Application Suprot sublayer, APS 어플리케이션 객체 중의 하나로 부터 제공될 수 있습니다.
      전송 중인 장비에서 각 계층은 계층의 헤더와 푸더(가능하다면)를 데이터 유닛 DU에 추가하고 다음 아래 계층으로 보냅니다.
      
      각 계층의 DU는 각 계층의 이름에 의하여 정의 됩니다. 위 그림처럼 APDU, NPDU, MPDU,DDPU등으로 불립니다. 
      
      수신측에서 데이타는 데이터가 DU의 목적지 계층에 도달할 때까지 헤더와 푸더를 벗기고 상위 계층으로 보냅니다.
      
### PHY MANAGEMENT SERVICE

    물리 계층 관리체 SAP ,PLME-SAP는 MLME(맥계층 관리체)와 PLME 사이의 전송을 명령하도록 이용됩니다.
    PLME-SAP를 통해 제공되는 서비스들은 다음과 같습니다.
    
   #### CCA, Clear channel assessment
         
          MLME는 CSMA-CA가 채널의 평가를 요구할 때마다 PLME가 CCA를 수행하도록 요청합니다. 
          CCA의 결과 값은 다음과 같을 수 있습니다.
          
          1. 송수신기가 사용 불가여서 CCA가 수행될 수 없다.
          2. 채널이 휴지 상태이고 전송을 할 수 있다.
          3. 채널 혹은 송수신기가 사용 중이다.
              a.  채널이 사용 중이다.( 다른 장비가 주파수 채널을 사용 중이다.)
              b.  장비가 전송을 하는 중이어서 cca 수행이 불가능하다.
         
         PLME 채널의 사용중과 장비의 사용 중을 구별할 수 없고 두 경우 모두 같은 BUSY 상태를 MLME에게 전송 합니다.
    
   #### ED, energy detection
   
          ED 요청은 MLME에 의하여 발생하고 PLME에 알려집니다. 만약 ED 측정이 성공적으로 완료 도니다면, 에너지 레벨은 MLME로 재보고 됩니다.
          무선 또는 송수신기가 비활성화되면 ED 요청이 실패합니다.
          
   #### Enabling and disabling the radio transceiver
 
        MLME는 PLME가 송수신기를 다음 3 상태 중 하나로 만들도록 요청 합니다. 
        
          1. 송수신기 사용불가
          2. 송신 사용 가능
          3. 수신 사용 가능
        
   #### Obtaining Information from the PHY-PIB ( PHY-PIB로 부터 정보 얻기)
   
        PLME는 PHY-PIB의 어떤 PHY 속성도 읽을 수 있고 그것을 MLME에 제공할 수 있습니다.
        PHY 속성을 읽는 요청은 항상 MLME에 의하여 생성 됩니다.
        
   #### Setting the Value of a PHY-PIB Attribute
   
        읽기 전용 PHY 속석은 오직 PHY에 의하여만 변경 될 수 있습니다. 
        그러나 다른 모든 속성의 경우 MLME가 PLME에게 PHY-PIB 속성을 주어진 값으로 변경 하도록 요청할 수 있습니다.
       
   
## THE SERVICE PRIMITIVES  서비스 준비

    IEEE 802.15.4 그리고 직비 표준은  한 계층이 다음 상위 계층 서비스 유저에게 제공하는 서비스를 묘사하기 위하여 
    기본 제공 개념을 사용 합니다.
    인접한 프로토콜 계층 간의 통신은 함수 기능 또는 계층간 기본 메세지 전송에 의하여 관리 됩니다.
    
    또한 각 계층은 전체 시스템에서 다른 규칙을 가지고 있지만 각 계층은 타 계층과 약간 비슷하게 작동합니다.
    예를 들어 PHY,MAC,NWK 계층은 상위 계층에 데이터 서비스를 제공 합니다. 
    3 계층 모두에서 전송을 위한 데이터 유닛 요청 매커니즘은 비슷합니다. 
    다음 상위 계층은 아래 계층의 DATA SAP(service access point)을 이용하여 데이터 전송을 요청 합니다.
    데이터 전송이 성공적이라면 아래 계층은 상위 계층에게 전송의 상태 확인을 제공합니다.
    
    이 유사점 때문에 서비스 기본 원칙들은 각 표준 프로토콜 계층의 기능을 설명 하는데 유용하게 사용 됩니다.
    각 기본 원칙은 수행할 작업을 지정하거나 이전 요청 작업 결과를 제공합니다.
    한 기본 원칙은 작업을 수행하는데 필요한 매개변수를 전달할 수도 있습니다.
    
    ![image](https://user-images.githubusercontent.com/43804441/51890853-99b60480-23e0-11e9-99cc-88f0824391f6.png)
    
    
    위 그림은 한 계층이 다음 계층에게 제공하는 서비스를 설명하는 일반적인 방법에 대해 나타나 있습니다.
    보는 것 처럼 4가지의 일반적인 서비스 타입이 있습니다.  요청, 지시, 반응, 확인
    즉, IEEE 802.15.4 및 ZigBee 표준에 설명된 모든 서비스는 위 네 가지 범주 중 하나로 분류됩니다.
    서비스 원칙들은 위 포맷과 같습니다.
    
    #
    
    예를 들어, PHY 데이터 서비스에서, PD-DATA.request 원칙은 MPDU 전송을 요청하는 PHY를 위한 MAC 계층에서 생성됩니다.
    
    #
    
    지시 원칙은 서비스 N+1 계층의 중요한 이벤트를 나타내는 서비스 유저를 위한 N계층에 이해 생성됩니다.
    예를 들어 PHY가 MAC 계층으로 전달해야하는 네트워크의 다른 장비에게서 데이터를 수신 할 때
    PHY는 데이터 정보를 MAC에게 전달 하기 위하여 PD-DATA.indication 원칙을 사용합니다.
    
    #
    
    만약 지시 원칙이 반응을 요청하면, 반응 원칙은 서비스 유저에서 N계층으로 전달 됩니다.
    PHY 와 NWK 계층은 어떤 반응 원칙도 가지지 않습니다.
    MAC과 APL 계층은 반응 원칙을 포함합니다.
    
    #
    
    확인 원칙은 요청원칙을 전달하여 요청된 N+1 서비스 계층의 완료를 확인하는 N계층에 의하여 사용됩니다.
    PD-DATA.confirm 원칙은 PHY entity에 의해 발생되고 PD-DATA.request원칙에 응답하여 MAC 부계층 entity에 보고 됩니다.
    확인에서 PHY는 전송이 성공여부를 MAC에게 알립니다.
    
    
## PHY PACKET FORMAT
    
![image](https://user-images.githubusercontent.com/43804441/51892200-85740680-23e4-11e9-9c31-0a77496d6f17.png)
    
     PPDU 포맷은 위 그림과 같습니다. PPDU 3가지 요소로 구성됩니다. 
     동기 헤더 Synchronization header ( SHR ) ,
     PHY 헤더  ( PHR ),
     그리고 PHY 페이로드 
     
     SHR는 수신기가 동기화 되게 하고 비트 스트림을 고정시킵니다.
     PHR는 프레임 길이 정보를 포함합니다. 
     PHY 페이로드는 상위 계층으로부터 제공되고 데이터 혹은 다른 장비로 전송을 위한 명령을 포함합니다.
     
     SHR는 한 개의 프리앰블과 한 개의 start-of-frame delimiter(SFD)로 구성됩니다.
      수신기는 프리앰블 필드를 사용하여 칩 및 기호 동기화를 얻습니다.
      모든 PHY의 프리앰블 필드의 비트는 ( ASK PHY는 제외하고 ) 이진 비트 입니다.
      868MHz ASK PHY 프리앰플은 아래표의 시퀀스 0을 두번 반복하여 생성합니다.
      
      표 A.1
![image](https://user-images.githubusercontent.com/43804441/51892927-b6553b00-23e6-11e9-8e7d-1f79dd30b5f9.png)   

      이 프리앰블의 지속 시간은 160μs입니다. 915MHz ASK PHY에서
      표 A.2의 시퀀스 0은 6회 반복되며 120μs가 소요됩니다.
      
![image](https://user-images.githubusercontent.com/43804441/51893056-1cda5900-23e7-11e9-9b34-55672f09a305.png)    

      모든 PHY 옵션에서 프리앰블의 길이와 지속 시간은 아래 표와 같습니다.
      
      표 3.4
![image](https://user-images.githubusercontent.com/43804441/51893106-472c1680-23e7-11e9-82fb-bfe5ef4b3b55.png)


      SFD 필드는 SHR의 끝과 PHR의 시작을 나타냅니다. 
      868MHz 및 915MHz ASK PHY에 대한 SFD는 각각 표 A.1과 A.2의 반전된 시퀀스 0입니다.
      다른 모든 PHY의 경우, SFD는 표 3.5에 나와 있는 8비트 필드입니다. SFD 필드의 길이는 표 3.6 에 나와 있습니다
    

![image](https://user-images.githubusercontent.com/43804441/51893213-970add80-23e7-11e9-8977-f614e4596b1f.png)

![image](https://user-images.githubusercontent.com/43804441/51893229-a38f3600-23e7-11e9-8d30-2fbc2523556a.png)   

      PHY 패킷의 다음 필드는 프레임 길이이며, 이는 PHY 페이로드(PSDU)의 총 옥oct 수를 지정합니다. 
    PSDU 길이는 0 ~ 127 옥ets 값일 수 있습니다(표 3.2 , PHY 상수 참조).
    그러나 실제로 IEEE 802.15.4-2006에 따르면 PSDU 길이는 MAC 수신 프레임의 경우 5 옥 oct이거나 다른 모든 MPD의 경우 9–127입니다. 
    0–4 및 6–8의 프레임 길이 값은 향후 발생할 수 있는 애플리케이션용으로 예약되어 있습니다(표 3.7).


      마지막 필드는 PHY 서비스 데이터 단위(PSDU)입니다. 
      PSDU의 내용은 MAC에서 MAC 프레임으로 제공됩니다. IEEE 802.15.4에서 첫 번째로 전송되는 비트는 SHR의 최소 유효 비트(LSB)입니다. 
      PHY 페이로드의 마지막 8진수에서 가장 중요한 비트(MSB)가 마지막으로 전송됩니다.
